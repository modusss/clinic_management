<!DOCTYPE html>
<html>
<head>
  <title>Clinic management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  
  <%= javascript_importmap_tags %>
  <%#= stimulus_include_tags %>
  
  <%= stylesheet_link_tag "clinic_management/application", media: "all", "data-turbo-track": "reload" %>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <%= stylesheet_link_tag "clinic_management/table", "data-turbo-track": "application" %>
  <%= stylesheet_link_tag "clinic_management/table", "data-turbo-track": "reload" %>
  <%= stylesheet_link_tag "clinic_management/main", "data-turbo-track": "reload" %>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Move custom styles here to ensure they are loaded before the body renders -->
  <style>
    /* Prevenir zoom em todos os elementos */
    * {
      touch-action: pan-x pan-y !important;
      -ms-touch-action: pan-x pan-y !important;
    }
    
    html, body {
      touch-action: pan-x pan-y !important;
      -ms-touch-action: pan-x pan-y !important;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    
    button, a {
      touch-action: manipulation !important;
      -ms-touch-action: manipulation !important;
    }
    
    @media (min-width: 768px) {
      #main-container {
        margin-left: 280px;
      }
    }

    @media (max-width: 768px) {
      #main-container {
        display: flex;
      }
    }
  </style>
  
  <!-- Script para prevenir zoom no mobile -->
  <script>
    (function() {
      'use strict';
      
      // Prevenir zoom por pinch (dois dedos) - funciona em Android e iOS
      document.addEventListener('touchmove', function(event) {
        if (event.touches && event.touches.length > 1) {
          event.preventDefault();
        }
      }, { passive: false });

      // Prevenir zoom por gestos (iOS Safari apenas)
      document.addEventListener('gesturestart', function(event) {
        event.preventDefault();
      }, { passive: false });

      document.addEventListener('gesturechange', function(event) {
        event.preventDefault();
      }, { passive: false });

      document.addEventListener('gestureend', function(event) {
        event.preventDefault();
      }, { passive: false });

      // Aplicar CSS touch-action para prevenir zoom
      document.addEventListener('DOMContentLoaded', function() {
        document.body.style.touchAction = 'pan-x pan-y';
        document.documentElement.style.touchAction = 'pan-x pan-y';
      });
    })();
  </script>

  <!-- Global Loading Script - Shows loader after 2s delay, fallback UI after 5s -->
  <script>
    (function() {
      'use strict';

      /**
       * Timing Configuration
       * - DELAY: Time before showing loading overlay (2 seconds)
       * - FALLBACK_DELAY: Time before showing escape options (5 seconds)
       * - SAFETY_TIMEOUT: Max time overlay can stay visible; force-hide after (60s). Prevents stuck overlay.
       */
      var DELAY = 2000;
      var FALLBACK_DELAY = 5000;
      var SAFETY_TIMEOUT = 60000;

      var timeout = null;
      var fallbackTimeout = null;
      var safetyTimeout = null;
      var overlay = null;
      var fallback = null;

      /**
       * Flag to temporarily suppress the loading overlay.
       * Set to true when a tel: or mailto: link is clicked, cleared after 1 second.
       * ESSENTIAL: This prevents beforeunload/turbo:visit events (which lack detail.url)
       * from triggering the loading overlay when the browser opens a phone/email app.
       */
      var suppressLoading = false;

      function getOverlay() {
        if (!overlay) overlay = document.getElementById('global-loading-overlay');
        return overlay;
      }

      function getFallback() {
        if (!fallback) fallback = document.getElementById('global-loading-fallback');
        return fallback;
      }

      /**
       * Shows the loading overlay and starts fallback timer and safety timeout
       */
      function show() {
        var el = getOverlay();
        if (el) {
          el.classList.remove('opacity-0', 'invisible');
          el.classList.add('opacity-100', 'visible');
          el.setAttribute('aria-hidden', 'false');

          // Start fallback timer after overlay is visible
          startFallbackTimer();
          // Safety net: force-hide if no Turbo event hides it (e.g. network error)
          startSafetyTimeout();
        }
      }

      /**
       * Shows the fallback UI with escape options
       */
      function showFallback() {
        var fb = getFallback();
        if (fb) {
          fb.classList.add('global-loading-fallback--visible');
          fb.setAttribute('aria-hidden', 'false');
        }
      }

      /**
       * Hides the fallback UI
       */
      function hideFallback() {
        var fb = getFallback();
        if (fb) {
          fb.classList.remove('global-loading-fallback--visible');
          fb.setAttribute('aria-hidden', 'true');
        }
      }

      /**
       * Hides everything and clears all timers (including safety timeout)
       */
      function hide() {
        clearAllTimers();
        hideFallback();

        var el = getOverlay();
        if (el) {
          el.classList.add('opacity-0', 'invisible');
          el.classList.remove('opacity-100', 'visible');
          el.setAttribute('aria-hidden', 'true');
        }
      }

      /**
       * Starts safety timeout: force-hide overlay after SAFETY_TIMEOUT ms if no Turbo event hid it.
       */
      function startSafetyTimeout() {
        if (safetyTimeout) clearTimeout(safetyTimeout);
        safetyTimeout = setTimeout(hide, SAFETY_TIMEOUT);
      }

      /**
       * Starts the initial loading timer (2s).
       * Skips overlay for non-navigation links (tel:, mailto:) and for
       * record_message_sent requests (background tracking, not full page load).
       *
       * ESSENTIAL: Also checks the originating anchor element to catch cases where
       * events like turbo:visit or beforeunload are triggered by tel:/mailto: links
       * but don't carry ev.detail.url (causing infinite loading overlay).
       */
      function startTimer(ev) {
        if (timeout) return;

        // ESSENTIAL: If a tel:/mailto: link was recently clicked, suppress loading.
        // The beforeunload event from these links has no detail.url to filter on.
        if (suppressLoading) return;

        // Check ev.detail.url for Turbo fetch events
        if (ev && ev.detail && ev.detail.url) {
          var u = String(ev.detail.url);
          if (u.indexOf('tel:') === 0 || u.indexOf('mailto:') === 0) return;
          if (u.indexOf('record_message_sent') !== -1) return;
          if (u.indexOf('toggle_whatsapp_status') !== -1) return;
          if (u.indexOf('verify_whatsapp') !== -1) return;
        }

        // Check the originating element for tel:/mailto: links
        // Catches turbo:visit events that don't carry detail.url
        if (ev && ev.target) {
          var anchor = ev.target.closest ? ev.target.closest('a[href]') : null;
          if (anchor) {
            var href = anchor.getAttribute('href') || '';
            if (href.indexOf('tel:') === 0 || href.indexOf('mailto:') === 0) return;
          }
        }

        // Check detail.fetchOptions for Turbo fetch requests with background tracking URLs
        // (e.g. Turbo Stream requests from sendInteractionRecord)
        if (ev && ev.detail && ev.detail.fetchOptions && ev.detail.fetchOptions.headers) {
          var accept = ev.detail.fetchOptions.headers['Accept'] || '';
          if (accept.indexOf('text/vnd.turbo-stream.html') !== -1) return;
        }

        timeout = setTimeout(show, DELAY);
      }

      /**
       * Starts the fallback timer (5s from when loading appears)
       */
      function startFallbackTimer() {
        if (fallbackTimeout) return;
        fallbackTimeout = setTimeout(showFallback, FALLBACK_DELAY);
      }

      /**
       * Clears all timers (show, fallback, and safety timeout)
       */
      function clearAllTimers() {
        if (timeout) { clearTimeout(timeout); timeout = null; }
        if (fallbackTimeout) { clearTimeout(fallbackTimeout); fallbackTimeout = null; }
        if (safetyTimeout) { clearTimeout(safetyTimeout); safetyTimeout = null; }
      }

      // Turbo Drive events
      document.addEventListener('turbo:before-fetch-request', startTimer);
      document.addEventListener('turbo:before-fetch-response', hide);
      // ESSENTIAL: Fires when fetch fails (e.g. network error); before-fetch-response is NOT fired then
      document.addEventListener('turbo:fetch-request-error', hide);
      document.addEventListener('turbo:visit', startTimer);
      document.addEventListener('turbo:load', hide);
      document.addEventListener('turbo:submit-start', startTimer);
      document.addEventListener('turbo:submit-end', hide);

      // Browser reload (F5, Ctrl+R)
      window.addEventListener('beforeunload', startTimer);

      /**
       * Suppress loading overlay for tel: and mailto: links.
       * ESSENTIAL: When clicking tel:/mailto: links, browsers may fire beforeunload
       * (to open the phone/email app) which has no detail.url â€” causing the loading
       * overlay to appear and never disappear (infinite loading bug).
       * This click listener runs BEFORE beforeunload, setting a flag to skip the timer.
       */
      document.addEventListener('click', function(ev) {
        var anchor = ev.target.closest ? ev.target.closest('a[href]') : null;
        if (anchor) {
          var href = anchor.getAttribute('href') || '';
          if (href.indexOf('tel:') === 0 || href.indexOf('mailto:') === 0) {
            suppressLoading = true;
            // Clear the flag after 2 seconds (enough time for beforeunload to fire)
            setTimeout(function() { suppressLoading = false; }, 2000);
          }
        }
      }, true); // Use capture phase to run before other handlers

      // Keyboard support: Escape key to go back
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          var el = getOverlay();
          if (el && !el.classList.contains('invisible')) {
            globalLoadingGoBack();
          }
        }
      });

      /**
       * Global fallback action handlers
       * Exposed to window for onclick handlers in the HTML
       */
      window.globalLoadingGoBack = function() {
        hide();
        window.history.back();
      };

      window.globalLoadingReload = function() {
        hide();
        window.location.reload();
      };

      window.globalLoadingGoHome = function() {
        hide();
        window.location.href = '/';
      };
    })();
  </script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal" style="margin-bottom: 200px">
  <%# Global loading overlay - shows when requests take > 2 seconds %>
  <%= render "clinic_management/shared/global_loading" %>

  <%= render "clinic_management/shared/navbar" %>
  <%= render "clinic_management/shared/scroll_buttons" %>
  <%= content_for?(:breadcrumb) ? yield(:breadcrumb) : '' %>
  <br>
  <br>
  <br>
  <main class="my-8" id="main-container">
    <div class="container mx-auto">
      <%= yield %>
    </div>
  </main>

  <footer class="bg-gradient-to-r from-emerald-900 via-emerald-800 to-emerald-900 py-4 mt-16 fixed bottom-0 inset-x-0 shadow-md" style="z-index: 2000">
    <div class="container mx-auto text-center">
      <p class="text-white text-base font-medium">
        &copy; <%= Time.now.year %> - <%= yield(:footer) || "Nome da sua empresa" %>
      </p>
    </div>
  </footer>
</body>
</html>