<%# ============================================================================
    Self-Booking: Change Identity Screen
    
    Shown when the patient indicates they are not the expected person.
    Allows them to enter their correct name and optionally a different phone.
    
    LOGIC:
    - Same phone as original lead -> appointment linked to original lead
    - Different phone that exists -> appointment linked to that phone's lead
    - Different phone that's new -> creates new lead with that phone
    ============================================================================ %>

<!-- Step indicator -->
<div class="step-indicator">
  <div class="step-dot active"></div>
  <div class="step-dot"></div>
  <div class="step-dot"></div>
  <div class="step-dot"></div>
</div>

<!-- Back button -->
<%= link_to self_booking_path(@lead.self_booking_token), class: "back-btn" do %>
  <i class="fas fa-arrow-left"></i>
  Voltar
<% end %>

<!-- Main card -->
<div class="booking-card">
  <div class="text-center mb-6">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
      <i class="fas fa-user-edit text-blue-600 text-2xl"></i>
    </div>
  </div>
  
  <h2 class="text-xl font-bold text-gray-900 text-center mb-2">
    Não é <%= @patient_name %>?
  </h2>
  
  <p class="text-gray-600 text-center mb-6">
    Informe os dados do paciente que será atendido
  </p>
  
  <%= form_with url: self_booking_update_name_path(@lead.self_booking_token), 
                method: :post, 
                local: true,
                class: "space-y-4" do |f| %>
    
    <%# Patient name field %>
    <div>
      <label for="patient_name" class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-user text-gray-400 mr-1"></i>
        Nome do paciente
      </label>
      <input type="text" 
             name="patient_name" 
             id="patient_name"
             required
             autofocus
             placeholder="Ex: Maria Silva"
             class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-lg
                    focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 
                    focus:outline-none transition-all"
             value="">
    </div>
    
    <%# Phone field - pre-filled with current lead's phone %>
    <div>
      <label for="patient_phone" class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-phone text-gray-400 mr-1"></i>
        Telefone (WhatsApp)
      </label>
      <input type="tel" 
             name="patient_phone" 
             id="patient_phone"
             required
             placeholder="(99) 99999-9999"
             inputmode="numeric"
             class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-lg
                    focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 
                    focus:outline-none transition-all"
             value="<%= @lead.phone.present? ? @lead.phone.gsub(/(\d{2})(\d{5})(\d{4})/, '(\1) \2-\3') : '' %>">
      <p class="mt-1 text-xs text-gray-500">
        <i class="fas fa-info-circle mr-1"></i>
        Mantenha o mesmo número ou informe outro
      </p>
    </div>
    
    <button type="submit" class="btn-primary">
      <i class="fas fa-arrow-right mr-2"></i>
      Continuar
    </button>
  <% end %>
</div>

<%# Phone mask script %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('patient_phone');
    if (phoneInput) {
      phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        
        if (value.length > 0) {
          if (value.length <= 2) {
            value = '(' + value;
          } else if (value.length <= 7) {
            value = '(' + value.slice(0, 2) + ') ' + value.slice(2);
          } else {
            value = '(' + value.slice(0, 2) + ') ' + value.slice(2, 7) + '-' + value.slice(7);
          }
        }
        e.target.value = value;
      });
    }
  });
</script>
