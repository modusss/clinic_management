<%# Cards view for absent leads, using the same data as the table (rows) %>

<!-- Container com setas de navegação para mobile -->
<div class="relative">
  <!-- Setas de navegação posicionadas acima dos cards (apenas mobile) -->
  <div class="md:hidden flex justify-between items-center mb-4 px-2">
    <!-- Seta Esquerda -->
    <button 
      type="button"
      class="bg-gray-800 bg-opacity-50 hover:bg-opacity-70 text-white rounded-full p-3 shadow-lg transition-all duration-200"
      onclick="scrollCardsLeft()"
      id="scroll-left-btn"
      style="display: none;">
      <i class="fas fa-chevron-left text-xl"></i>
    </button>

    <!-- Espaço vazio no meio -->
    <div class="flex-1"></div>

    <!-- Seta Direita -->
    <button 
      type="button"
      class="bg-gray-800 bg-opacity-50 hover:bg-opacity-70 text-white rounded-full p-3 shadow-lg transition-all duration-200"
      onclick="scrollCardsRight()"
      id="scroll-right-btn">
      <i class="fas fa-chevron-right text-xl"></i>
    </button>
  </div>

  <!-- Container de cards com scroll horizontal no mobile -->
  <div 
    id="cards-container"
    class="overflow-x-auto snap-x snap-mandatory md:overflow-visible md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4"
    onscroll="updateNavigationButtons()">
    <div class="flex md:contents md:gap-0">
    <% rows.each_with_index do |row, index| %>
    <% lead = leads[index] %>
    <div class="bg-white rounded shadow p-4 mb-4 relative flex-shrink-0 w-screen md:w-auto snap-start" id="lead-card-<%= lead.id %>">
      <% if rows.any? %>
        <%# Checkbox de seleção (só aparece se Evolution API ativo) %>
        <% if can_use_evolution_api? %>
          <div class="absolute top-2 left-2 z-10">
            <%= check_box_tag "lead_#{lead.id}", 
                  lead.id, 
                  false,
                  class: "w-6 h-6 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer",
                  data: { 
                    bulk_message_target: "leadCheckbox",
                    lead_id: lead.id,
                    lead_phone: lead.phone,
                    lead_name: lead.name,
                    action: "change->bulk-message#updateCounter"
                  } %>
          </div>
        <% end %>
        <%# Botões de ação no topo do card - Enfileirados horizontalmente %>
        <% if params[:hidden_status] == "visible" || params[:hidden_status].blank? %>
          <div class="mb-4">
            <p class="text-xs text-gray-600 mb-2 text-right">Lançar ficha para a lista de:</p>
            <div class="flex flex-wrap gap-2 justify-end">
            
            <%= button_to clinic_management.hide_from_absent_lead_path(lead), 
                method: :patch,
                remote: true,
                data: { 
                  turbo_method: :patch,
                  turbo_stream: true,
                  confirm: "Tem certeza que deseja ocultar este lead da listagem?"
                },
                class: "bg-red-500 hover:bg-red-600 active:bg-red-700 text-white text-xs px-2 py-1 rounded shadow-sm flex items-center gap-1 transition-all duration-200 transform hover:scale-105 active:scale-95",
                title: "Ocultar da lista" do %>
              <i class="fas fa-calendar-plus"></i> 
              <span>Contato futuro</span>
            <% end %>
            
            <%= button_to clinic_management.mark_no_interest_lead_path(lead), 
                method: :patch,
                remote: true,
                data: { 
                  turbo_method: :patch,
                  turbo_stream: true,
                  confirm: "Marcar este lead como 'Sem interesse'?"
                },
                class: "bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white text-xs px-2 py-1 rounded shadow-sm flex items-center gap-1 transition-all duration-200 transform hover:scale-105 active:scale-95",
                title: "Sem interesse" do %>
              <i class="fas fa-times"></i> 
              <span>Sem Interesse</span>
            <% end %>
            
            <%= button_to clinic_management.mark_wrong_phone_lead_path(lead), 
                method: :patch,
                remote: true,
                data: { 
                  turbo_method: :patch,
                  turbo_stream: true,
                  confirm: "Marcar este lead como 'Telefone errado'?"
                },
                class: "bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white text-xs px-2 py-1 rounded shadow-sm flex items-center gap-1 transition-all duration-200 transform hover:scale-105 active:scale-95",
                title: "Telefone errado" do %>
              <i class="fas fa-phone-slash"></i> 
              <span>Telefone errado</span>
            <% end %>
            </div>
          </div>
        <% else %>
          <div class="flex justify-end mb-4">
            <%= button_to clinic_management.restore_lead_lead_path(lead), 
                method: :patch,
                remote: true,
                data: { 
                  turbo_method: :patch,
                  turbo_stream: true,
                  confirm: "Tem certeza que deseja restaurar este lead na listagem principal?"
                },
                class: "bg-green-500 hover:bg-green-600 active:bg-green-700 text-white text-xs px-3 py-1 rounded shadow-sm flex items-center gap-1 transition-all duration-200 transform hover:scale-105 active:scale-95",
                title: "Restaurar na lista principal" do %>
              <i class="fas fa-undo"></i> 
              <span>Restaurar</span>
            <% end %>
          </div>
        <% end %>
        
        <%# Exibe cada campo do row, com header e content, igual à tabela, mas em formato de cartão %>
        <% row.each do |cell| %>
          <div class="mb-2" id="<%= cell[:id] %>">
            <span class="block text-xs text-gray-500 font-semibold"><%= cell[:header] %></span>
            <span class="block text-base text-gray-800" style="margin-top: 10px;"><%= cell[:content] %></span>
          </div>
        <% end %>
      <% else %>
        <div class="bg-white rounded shadow p-4 mb-4">
          <span class="block text-base text-gray-800">Nenhum paciente agendado</span>
        </div>
      <% end %>
    </div>
  <% end %>
    </div><!-- Fecha flex container -->
  </div><!-- Fecha cards-container -->
</div><!-- Fecha relative container -->

<%# Add pagination for cards view, just like the table view %>
<% if defined?(leads) && leads.size > 10 %>
  <%= paginate leads %>
<% end %> 

<script>
// Funções de navegação do carrossel mobile
function scrollCardsLeft() {
  const container = document.getElementById('cards-container');
  const card = container.querySelector('.bg-white');
  if (!card) return;
  
  // Pegar a largura exata do card (100vw no mobile)
  const cardWidth = card.offsetWidth;
  
  // Scroll instantâneo (sem behavior: 'smooth')
  container.scrollBy({
    left: -cardWidth,
    behavior: 'auto'
  });
}

function scrollCardsRight() {
  const container = document.getElementById('cards-container');
  const card = container.querySelector('.bg-white');
  if (!card) return;
  
  // Pegar a largura exata do card (100vw no mobile)
  const cardWidth = card.offsetWidth;
  
  // Scroll instantâneo (sem behavior: 'smooth')
  container.scrollBy({
    left: cardWidth,
    behavior: 'auto'
  });
}

function updateNavigationButtons() {
  const container = document.getElementById('cards-container');
  const leftBtn = document.getElementById('scroll-left-btn');
  const rightBtn = document.getElementById('scroll-right-btn');
  
  if (!container || !leftBtn || !rightBtn) return;
  
  // Mostrar/ocultar seta esquerda
  if (container.scrollLeft <= 10) {
    leftBtn.style.display = 'none';
  } else {
    leftBtn.style.display = 'block';
  }
  
  // Mostrar/ocultar seta direita
  const isAtEnd = container.scrollLeft + container.clientWidth >= container.scrollWidth - 10;
  if (isAtEnd) {
    rightBtn.style.display = 'none';
  } else {
    rightBtn.style.display = 'block';
  }
}

// Inicializar ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
  updateNavigationButtons();
  
  // Atualizar ao redimensionar
  window.addEventListener('resize', updateNavigationButtons);
});

// Atualizar imediatamente (para Turbo)
updateNavigationButtons();
</script>

<style>
/* Estilo para scroll horizontal no mobile */
#cards-container {
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

#cards-container::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

@media (max-width: 768px) {
  .pagination {
    flex-direction: column;
  }

  .pagination li {
    margin: 10px;
  }
}
</style>