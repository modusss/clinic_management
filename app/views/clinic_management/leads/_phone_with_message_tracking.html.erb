<!-- Turbo stream para receber atualizaÃ§Ãµes quando uma interaÃ§Ã£o Ã© criada -->
<%= turbo_stream_from "lead_#{lead.id}_phone_tracking" %>

<div id="phone-container-<%= lead.id %>" 
     data-controller="message-tracking"
     data-message-tracking-lead-id-value="<%= lead.id %>"
     data-message-tracking-appointment-id-value="<%= appointment.id %>"
     data-message-tracking-no-whatsapp-value="<%= lead.no_whatsapp || false %>"
     data-message-tracking-persist-hint-value="<%= local_assigns[:persist_hint] || false %>"
     data-message-tracking-row-id-value="lead-row-<%= lead.id %>">
  <div class="flex items-center">
    <% if lead.phone.present? %>
      <div class="flex items-center gap-2">
        <%= link_to add_phone_mask(lead.phone), 
                    whatsapp_link(lead.phone, ""), 
                    target: '_blank',
                    data: { 
                      action: "click->message-tracking#recordMessageSent"
                    },
                    class: "whatsapp-link #{'opacity-50' unless lead.has_whatsapp?}" %>
        
        <% if current_account&.directcall_configured? %>
          <div class="flex items-center gap-2">
            <%# BotÃ£o Ligar %>
            <button type="button"
                    style="display: inline-flex; align-items: center; background: none; border: none; color: #4B5563; cursor: pointer; padding: 0; font: inherit;"
                    title="Ligar para <%= lead.phone %>"
                    data-phone="<%= current_user&.phone_prefix.present? ? current_user.phone_prefix : '' %><%= lead.phone %>"
                    data-context="<%= local_assigns[:persist_hint] ? 'absent' : 'other' %>"
                    data-action="click->message-tracking#makeDirectcallCall">
              <i class="fas fa-phone" style="margin-right: 4px;"></i>
              <span style="font-size: 15px;">Ligar</span>
            </button>
            
            <%# BotÃ£o Adicionar Ã  Fila (apenas na pÃ¡gina de ausentes) %>
            <% if local_assigns[:persist_hint] %>
              <% 
                # Buscar appointment completo para pegar observaÃ§Ãµes e data do serviÃ§o
                full_appointment = ClinicManagement::Appointment.includes(:service).find_by(id: appointment.id)
                service_date = full_appointment&.service&.date&.strftime("%d/%m/%Y") || "Data nÃ£o disponÃ­vel"
                appointment_comments = full_appointment&.comments.presence || "Sem observaÃ§Ãµes"
                
                # Determinar status baseado em attendance
                status_text = if appointment.attendance == false
                  "Ausente"
                else
                  "Atendeu hÃ¡ mais de 1 ano"
                end
              %>
              <button type="button"
                      class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 border border-blue-300 rounded hover:bg-blue-50 transition"
                      title="Adicionar Ã  fila de ligaÃ§Ãµes"
                      data-action="click->call-queue#addToQueue"
                      data-lead-id="<%= lead.id %>"
                      data-appointment-id="<%= appointment.id %>"
                      data-lead-name="<%= lead.name %>"
                      data-lead-phone="<%= lead.phone %>"
                      data-service-date="<%= service_date %>"
                      data-appointment-comments="<%= appointment_comments %>"
                      data-status="<%= status_text %>">
                <i class="fas fa-plus-circle mr-1"></i>
                Fila
              </button>
            <% end %>
          </div>
        <% else %>
          <%# Fallback para link tel: tradicional %>
          <a style="display: inline-flex; align-items: center; color: #4B5563; text-decoration: none;" 
             href="tel:<%= current_user&.phone_prefix.present? ? current_user.phone_prefix : '' %><%= lead.phone %>" 
             title="Ligar para <%= current_user&.phone_prefix.present? ? current_user.phone_prefix : '' %><%= lead.phone %>"
             data-action="click->message-tracking#recordMessageSent">
            <i class="fas fa-phone" style="margin-right: 4px;"></i>
            <span style="font-size: 15px;">Ligar</span>
            <% if current_user&.phone_prefix.present? %>
              <span style="font-size: 10px; color: #9CA3AF; margin-left: 4px;" title="Prefixo configurado: <%= current_user.phone_prefix %>">(<%= current_user.phone_prefix %>)</span>
            <% end %>
          </a>
        <% end %>
        
        <!-- WhatsApp Status Toggle -->
        <div class="flex items-center ml-2">
          <span class="text-xs text-gray-600 mr-1">WhatsApp:</span>
          <button type="button"
                  data-action="click->message-tracking#toggleWhatsappStatus"
                  class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 <%= lead.has_whatsapp? ? 'bg-green-600' : 'bg-gray-200' %>"
                  title="<%= lead.has_whatsapp? ? 'Clique para marcar como sem WhatsApp' : 'Clique para marcar como tem WhatsApp' %>">
            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition duration-200 ease-in-out <%= lead.has_whatsapp? ? 'translate-x-6' : 'translate-x-1' %>">
              <i class="fab fa-whatsapp text-xs <%= lead.has_whatsapp? ? 'text-green-600' : 'text-gray-400' %>" style="font-size: 13px; margin-left: 1px; margin-top: 1px; position: absolute; right: 2px; bottom: 0px"></i>
            </span>
          </button>
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- EstatÃ­sticas das interaÃ§Ãµes com dropdown -->
  <% if lead.lead_interactions.any? %>
    <div class="text-xs text-gray-500 mt-1 relative">
      <div class="flex items-center gap-2">
        <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">
          ðŸ“ž <%= lead.lead_interactions.whatsapp_click.count %>x
        </span>
        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">
          <i class="fab fa-whatsapp text-xs"></i> <%= lead.lead_interactions.phone_call.count %>x
        </span>
        
        <!-- BotÃ£o discreto para abrir histÃ³rico -->
        <button type="button" 
                class="text-gray-400 hover:text-gray-600 ml-1"
                data-action="click->message-tracking#toggleHistory"
                title="Ver histÃ³rico de contatos">
          <i class="fas fa-history text-xs"></i>
        </button>
      </div>
      
      <% if lead.lead_interactions.recent.first %>
        <div class="text-xs mt-1">
          Ãšltima: <%= time_ago_in_words(lead.lead_interactions.recent.first.occurred_at) %> atrÃ¡s 
          por <%= lead.lead_interactions.recent&.first&.user&.name %>
        </div>
        
        <!-- Destacar quando o usuÃ¡rio atual enviou a Ãºltima mensagem -->
        <% if lead.lead_interactions.recent.first.user == current_user %>
          <div class="text-xs mt-1 bg-blue-50 text-blue-700 px-2 py-1 rounded inline-block">
            <i class="fas fa-user-check text-xs mr-1"></i>
            VocÃª enviou hÃ¡ <%= time_ago_in_words(lead.lead_interactions.recent.first.occurred_at) %>
          </div>
        <% end %>
      <% end %>
      
      <!-- Dropdown do histÃ³rico -->
      <div class="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 min-w-80 hidden"
           data-message-tracking-target="historyDropdown">
        <div class="p-3">
          <div class="flex justify-between items-center mb-2">
            <h4 class="font-medium text-gray-700 text-sm">HistÃ³rico de Contatos</h4>
            <button type="button" 
                    class="text-gray-400 hover:text-gray-600"
                    data-action="click->message-tracking#toggleHistory">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
          
          <div class="max-h-64 overflow-y-auto">
            <% lead.lead_interactions.recent.limit(20).each do |interaction| %>
              <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                <div class="flex items-center gap-2">
                  <% if interaction.whatsapp_click? %>
                    <span class="text-green-600" title="WhatsApp">ðŸ“±</span>
                  <% else %>
                    <span class="text-blue-600" title="LigaÃ§Ã£o">ðŸ“ž</span>
                  <% end %>
                  
                  <div class="text-xs">
                    <div class="font-medium text-gray-700">
                      <%= interaction&.user&.name %>
                    </div>
                    <div class="text-gray-500">
                      <%= l(interaction.occurred_at, format: "%d/%m/%Y Ã s %H:%M") %>
                    </div>
                  </div>
                </div>
                
                <div class="text-xs text-gray-400">
                  <%= time_ago_in_words(interaction.occurred_at) %> atrÃ¡s
                </div>
              </div>
            <% end %>
            
            <% if lead.lead_interactions.count > 20 %>
              <div class="text-center py-2 text-xs text-gray-500">
                ... e mais <%= lead.lead_interactions.count - 20 %> interaÃ§Ãµes
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% elsif appointment.last_message_sent_at.present? %>
    <!-- Fallback para dados antigos -->
    <div class="text-xs text-gray-500 mt-1">
      Ãšltima mensagem: <%= time_ago_in_words(appointment.last_message_sent_at) %> atrÃ¡s 
      por <%= appointment.last_message_sent_by %>
    </div>
  <% end %>
</div> 