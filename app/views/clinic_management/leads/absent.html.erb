<%# render_menu(@menu) %>
<%# Toggle for table/cards view. Stores preference in a cookie. %>
<%= render partial: "clinic_management/shared/toggle_cards_table", locals: { 
      path: ->(args = {}) { absent_leads_path(params.permit(:year, :month, :patient_type, :contact_status, :whatsapp_status, :hidden_status, :sort_order, :tab).merge(args)) }, 
      cookie_name: "preferred_absent_view", 
      view_type: @view_type 
    } %>

<%# Wrapper para o sistema de fila de liga√ß√µes E envio em massa - ENVOLVE TODA A P√ÅGINA %>
<div data-controller="call-queue bulk-message" 
     data-call-queue-directcall-configured-value="<%= current_account&.directcall_configured? %>"
     data-bulk-message-leads-data-value="<%= @leads.map { |l| { id: l.id, phone: l.phone, name: l.name } }.to_json.gsub('"', '&quot;') %>">
  <%# O dropdown flutuante ser√° renderizado aqui %>
  <%= render partial: "clinic_management/leads/call_queue_dropdown" if current_account&.directcall_configured? %>

<% if referral?(current_user) %>
<h5 class="text-xl font-semibold text-gray-800">Lista dos pacientes ausentes mais antigos que 180 dias</h5>
<br>
<% end %>

<% if is_manager_above? %>
<!-- Tabs -->
<div class="mb-4">
  <ul class="flex border-b">
    <li class="-mb-px mr-1">
      <%= link_to 'Tabela', absent_leads_path, class: "bg-white inline-block py-2 px-4 text-blue-500 hover:text-blue-800 font-semibold #{params[:tab] != 'download' ? 'border-l border-t border-r rounded-t' : ''}" %>
    </li>
    <li class="mr-1">
      <%= link_to 'Download CSV', absent_leads_path(tab: 'download'), class: "bg-white inline-block py-2 px-4 text-blue-500 hover:text-blue-800 font-semibold #{params[:tab] == 'download' ? 'border-l border-t border-r rounded-t' : ''}" %>
    </li>
  </ul>
</div>
<% end %>

<% if params[:tab] == 'download' %>
  <!-- Download CSV Tab Content -->
  <div id="download-tab" class="tab-content">
    <!-- Nova tabela para download por ano/m√™s -->
<!-- Nova tabela para download por ano/m√™s -->
<table class="min-w-full bg-white border border-gray-300 mb-8">
  <thead>
    <tr>
      <th class="py-2 px-4 border-b">Ano</th>
      <th class="py-2 px-4 border-b">M√™s</th>
      <th class="py-2 px-4 border-b">Download</th>
    </tr>
  </thead>
  <tbody>
    <% if @all_leads.any? %>
      <% start_date = @all_leads.last.appointments.last.service.date %>
      <% end_date = @all_leads.first.appointments.last.service.date %>
      <% (start_date.to_date..end_date.to_date).map(&:beginning_of_month).uniq.reverse.each do |date| %>
        <% year = date.year %>
        <% month = date.month %>
        <% leads_for_month = @all_leads.select { |lead| lead.appointments.last.service.date.year == year && lead.appointments.last.service.date.month == month } %>
        <tr>
          <td class="py-2 px-4 border-b"><%= year %></td>
          <td class="py-2 px-4 border-b"><%= Date::MONTHNAMES[month] %></td>
          <td class="py-2 px-4 border-b">
            <% if leads_for_month.any? %>
              <%= link_to 'Baixar CSV', download_leads_leads_path(format: :csv, year: year, month: month), 
                          class: 'bg-blue-600 hover:bg-blue-800 text-white font-bold py-1 px-2 rounded text-sm' %>
            <% else %>
              <span class="text-gray-500">Sem leads</span>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td colspan="3" class="py-2 px-4 border-b text-center">Nenhum lead encontrado</td>
      </tr>
    <% end %>
  </tbody>
</table>

    <!-- Bot√£o para download geral -->
    <%= link_to 'Baixar lista completa de pacientes', download_leads_leads_path(format: :csv), 
                class: 'bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-4 rounded mb-8 inline-block' %>

  </div>
<% else %>

  <br>
  <br>
  <div class="relative">
    <%= form_with url: search_absents_leads_path, method: :post, data: { turbo_stream: true, controller: "debounce" }, class: "w-full sm:w-auto flex justify-center sm:justify-start mt-4 sm:mt-0" do |search| %>
      <div class="input-field relative" id="search-results-container">
        <%= search.search_field :q,
            data: { debounce_target: "input", action: "input->debounce#input" },
            id: "search_absent",
            placeholder: "Busque pelo nome do respons√°vel ou telefone...",
            autocomplete: "off",
            spellcheck: false,
            class: "bg-white rounded p-2 w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-transparent",
            style: "font-size: 16px; padding: 12px;" %>
        <label class="absolute right-2 top-1/2 transform -translate-y-1/2" for="search_lead">
          <i class="fas fa-search text-gray-500"></i>
        </label>
      </div>
    <% end %>
  </div>
  <br>
<!-- Formul√°rio de sele√ß√£o de ano/m√™s -->
<div class="my-4 p-4 bg-gray-100 rounded" data-controller="radio-button">
  <%= form_with url: absent_leads_path, method: :get,
                local: true,
                class: "flex flex-col sm:flex-row gap-4 flex-wrap" do |f| %>

    <!-- Campo Ano -->
    <div>
      <%= f.label :year, "Ano:", class: "block font-semibold mb-1" %>
      <%= f.select :year, 
          options_for_select(
            (Date.current.year - 5..Date.current.year).to_a.reverse, 
            params[:year]
          ), 
          { include_blank: "Selecione o ano" },
          class: "border rounded p-2"
      %>
    </div>

    <!-- Campo M√™s -->
    <div>
      <%= f.label :month, "M√™s:", class: "block font-semibold mb-1" %>
      <%= f.select :month, 
          options_for_select(
            (1..12).map { |m| [I18n.t("date.month_names")[m], m] }, 
            params[:month]
          ), 
          { include_blank: "Selecione o m√™s" },
          class: "border rounded p-2"
      %>
    </div>
    
    <!-- Filtro de Tipo de Paciente -->
    <div>
      <%= f.label :patient_type, class: "block font-semibold mb-2 flex items-center" do %>
        <i class="fas fa-user-injured mr-2 text-blue-600"></i> Tipo de Paciente:
      <% end %>
      <div class="flex flex-wrap gap-2">
        <%= f.radio_button :patient_type, "all", checked: (params[:patient_type] == "all" || params[:patient_type].blank?), class: "sr-only", id: "patient_type_all" %>
        <label for="patient_type_all" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:patient_type] == 'all' || params[:patient_type].blank? ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Todos</label>
        
        <%= f.radio_button :patient_type, "absent", checked: (params[:patient_type] == "absent"), class: "sr-only", id: "patient_type_absent" %>
        <label for="patient_type_absent" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:patient_type] == 'absent' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Ausente √∫ltimo atendimento</label>
        
        <%= f.radio_button :patient_type, "attended_year_ago", checked: (params[:patient_type] == "attended_year_ago"), class: "sr-only", id: "patient_type_attended_year_ago" %>
        <label for="patient_type_attended_year_ago" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:patient_type] == 'attended_year_ago' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Compareceu +1 ano</label>
        
        <%= f.radio_button :patient_type, "attended_year_ago_customer", checked: (params[:patient_type] == "attended_year_ago_customer"), class: "sr-only", id: "patient_type_attended_year_ago_customer" %>
        <label for="patient_type_attended_year_ago_customer" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:patient_type] == 'attended_year_ago_customer' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">J√° √© cliente +1 ano</label>
        
        <%= f.radio_button :patient_type, "attended_year_ago_non_customer", checked: (params[:patient_type] == "attended_year_ago_non_customer"), class: "sr-only", id: "patient_type_attended_year_ago_non_customer" %>
        <label for="patient_type_attended_year_ago_non_customer" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:patient_type] == 'attended_year_ago_non_customer' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">N√£o cliente +1 ano</label>
      </div>
    </div>
    <!-- Filtro de Contato -->
    <div>
      <%= f.label :contact_status, class: "block font-semibold mb-2 flex items-center" do %>
        <i class="fas fa-phone mr-2 text-green-600"></i> Status de Contato:
      <% end %>
      <div class="flex flex-wrap gap-2">
        <%= f.radio_button :contact_status, "all", checked: (params[:contact_status] == "all" || params[:contact_status].blank?), class: "sr-only", id: "contact_status_all" %>
        <label for="contact_status_all" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:contact_status] == 'all' || params[:contact_status].blank? ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Todos</label>
        
        <%= f.radio_button :contact_status, "not_contacted", checked: (params[:contact_status] == "not_contacted"), class: "sr-only", id: "contact_status_not_contacted" %>
        <label for="contact_status_not_contacted" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:contact_status] == 'not_contacted' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">N√£o contatados</label>
        
        <%= f.radio_button :contact_status, "contacted", checked: (params[:contact_status] == "contacted"), class: "sr-only", id: "contact_status_contacted" %>
        <label for="contact_status_contacted" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:contact_status] == 'contacted' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Contatados</label>
        
        <%= f.radio_button :contact_status, "contacted_by_me", checked: (params[:contact_status] == "contacted_by_me"), class: "sr-only", id: "contact_status_contacted_by_me" %>
        <label for="contact_status_contacted_by_me" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:contact_status] == 'contacted_by_me' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Contatados por mim</label>
      </div>
    </div>
    <!-- Filtro de WhatsApp -->
    <div>
      <%= f.label :whatsapp_status, class: "block font-semibold mb-2 flex items-center" do %>
        <i class="fab fa-whatsapp mr-2 text-green-600"></i> Status WhatsApp:
      <% end %>
      <div class="flex flex-wrap gap-2">
        <%= f.radio_button :whatsapp_status, "all", checked: (params[:whatsapp_status] == "all" || params[:whatsapp_status].blank?), class: "sr-only", id: "whatsapp_status_all" %>
        <label for="whatsapp_status_all" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:whatsapp_status] == 'all' || params[:whatsapp_status].blank? ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Todos</label>
        
        <%= f.radio_button :whatsapp_status, "has_whatsapp", checked: (params[:whatsapp_status] == "has_whatsapp"), class: "sr-only", id: "whatsapp_status_has_whatsapp" %>
        <label for="whatsapp_status_has_whatsapp" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:whatsapp_status] == 'has_whatsapp' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Tem WhatsApp</label>
        
        <%= f.radio_button :whatsapp_status, "no_whatsapp", checked: (params[:whatsapp_status] == "no_whatsapp"), class: "sr-only", id: "whatsapp_status_no_whatsapp" %>
        <label for="whatsapp_status_no_whatsapp" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:whatsapp_status] == 'no_whatsapp' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Sem WhatsApp</label>
      </div>
    </div>
    
    <!-- Filtro de Visibilidade -->
    <div>
      <%= f.label :hidden_status, class: "block font-semibold mb-2 flex items-center" do %>
        <i class="fas fa-eye mr-2 text-purple-600"></i> Status de Interesse:
      <% end %>
      <div class="flex flex-wrap gap-2">
        <%= f.radio_button :hidden_status, "visible", checked: (params[:hidden_status] == "visible" || params[:hidden_status].blank?), class: "sr-only", id: "hidden_status_visible" %>
        <label for="hidden_status_visible" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:hidden_status] == 'visible' || params[:hidden_status].blank? ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Dispon√≠vel</label>
        
        <%= f.radio_button :hidden_status, "hidden", checked: (params[:hidden_status] == "hidden"), class: "sr-only", id: "hidden_status_hidden" %>
        <label for="hidden_status_hidden" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:hidden_status] == 'hidden' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Contato futuro</label>
        
        <%= f.radio_button :hidden_status, "no_interest", checked: (params[:hidden_status] == "no_interest"), class: "sr-only", id: "hidden_status_no_interest" %>
        <label for="hidden_status_no_interest" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:hidden_status] == 'no_interest' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Sem interesse</label>
        
        <%= f.radio_button :hidden_status, "wrong_phone", checked: (params[:hidden_status] == "wrong_phone"), class: "sr-only", id: "hidden_status_wrong_phone" %>
        <label for="hidden_status_wrong_phone" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:hidden_status] == 'wrong_phone' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Telefone errado</label>
      </div>
    </div>
    
    <!-- Ordena√ß√£o -->
    <div>
      <%= f.label :sort_order, class: "block font-semibold mb-2 flex items-center" do %>
        <i class="fas fa-sort mr-2 text-orange-600"></i> Ordenar por:
      <% end %>
      <div class="flex flex-wrap gap-2">
        <%= f.radio_button :sort_order, "appointment_newest_first", checked: (params[:sort_order] == "appointment_newest_first" || params[:sort_order].blank?), class: "sr-only", id: "sort_order_appointment_newest_first" %>
        <label for="sort_order_appointment_newest_first" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:sort_order] == 'appointment_newest_first' || params[:sort_order].blank? ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">√öltimo atendimento mais recente</label>
        
        <%= f.radio_button :sort_order, "appointment_oldest_first", checked: (params[:sort_order] == "appointment_oldest_first"), class: "sr-only", id: "sort_order_appointment_oldest_first" %>
        <label for="sort_order_appointment_oldest_first" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:sort_order] == 'appointment_oldest_first' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">√öltimo atendimento mais antigo</label>
        
        <%= f.radio_button :sort_order, "contact_newest_first", checked: (params[:sort_order] == "contact_newest_first"), class: "sr-only", id: "sort_order_contact_newest_first" %>
        <label for="sort_order_contact_newest_first" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:sort_order] == 'contact_newest_first' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Contatado mais recente</label>
        
        <%= f.radio_button :sort_order, "contact_oldest_first", checked: (params[:sort_order] == "contact_oldest_first"), class: "sr-only", id: "sort_order_contact_oldest_first" %>
        <label for="sort_order_contact_oldest_first" class="px-3 py-2 text-sm border rounded cursor-pointer <%= params[:sort_order] == 'contact_oldest_first' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50' %>">Contatado h√° mais tempo</label>
      </div>
    </div>

    <!-- Bot√£o de busca -->
    <div class="flex items-end">
      <%= f.submit "Buscar", 
          class: "bg-blue-600 hover:bg-blue-800 text-white py-2 px-4 rounded" %>
    </div>
  <% end %>
</div>

  <br>
  
  <%# Formul√°rio de envio em massa - s√≥ aparece se Evolution API est√° ativo %>
  <% if can_use_evolution_api? || Rails.env.development? %>
  <div class="my-4 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md border border-blue-200">
    
    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
      <i class="fas fa-paper-plane text-blue-600"></i>
      Envio em Massa de Mensagens
    </h3>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <%# Sele√ß√£o de mensagem %>
      <div class="lg:col-span-2">
        <%= label_tag :bulk_message_id, "Escolha a mensagem:", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <% 
          # Buscar mensagens baseado no tipo de usu√°rio (igual ao index de lead_messages)
          bulk_messages = if referral?(current_user)
            ClinicManagement::LeadMessage.where(referral_id: user_referral.id)
          else
            ClinicManagement::LeadMessage.where(referral_id: nil)
          end
        %>
        <%= select_tag :bulk_message_id,
              options_from_collection_for_select(
                bulk_messages.order(:name),
                :id,
                :name
              ),
              { 
                include_blank: "Selecione uma mensagem",
                class: "w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
                data: { 
                  action: "change->bulk-message#updatePreview",
                  bulk_message_target: "messageSelect"
                }
              } %>
        
        <%# Preview da mensagem - renderizar previews para todas as mensagens (ocultos inicialmente) %>
        <div class="mt-3 p-3 bg-white rounded border border-gray-200 min-h-[80px]" 
             data-bulk-message-target="messagePreview">
          <p class="text-sm text-gray-500 italic">Selecione uma mensagem para ver a pr√©via</p>
        </div>
        
        <%# Previews ocultos para cada mensagem (ser√£o mostrados via JS) %>
        <% 
          # Criar appointment de exemplo para preview
          sample_lead = @leads.first
          sample_appointment = sample_lead&.appointments&.includes(:service)&.order('clinic_management_services.date DESC')&.first
        %>
        
        <% if sample_appointment.present? %>
          <% bulk_messages.each do |msg| %>
            <div id="preview-message-<%= msg.id %>" class="hidden" data-message-preview>
              <p class="text-sm font-semibold text-gray-700 mb-2"><%= msg.name %></p>
              
              <% if msg.text.match(/\[([^\]]+\|[^\]]+)\]/) %>
                <%# Mensagem tem varia√ß√µes aleat√≥rias - mostrar 2 exemplos %>
                <div class="space-y-3">
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <h6 class="text-xs font-semibold text-blue-800 mb-2">üì± Varia√ß√£o 1:</h6>
                    <div class="text-sm text-gray-800 whitespace-pre-wrap">
                      <%= generate_random_variation(msg.text, sample_appointment, 1).gsub("\n", "<br>").html_safe %>
                    </div>
                  </div>
                  <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <h6 class="text-xs font-semibold text-green-800 mb-2">üì± Varia√ß√£o 2:</h6>
                    <div class="text-sm text-gray-800 whitespace-pre-wrap">
                      <%= generate_random_variation(msg.text, sample_appointment, 2).gsub("\n", "<br>").html_safe %>
                    </div>
                  </div>
                  <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                    <p class="text-xs text-yellow-800">
                      <i class="fas fa-info-circle text-xs mr-1"></i>
                      O sistema escolher√° aleatoriamente uma das varia√ß√µes ao enviar.
                    </p>
                  </div>
                </div>
              <% else %>
                <%# Mensagem simples - mostrar preview formatado %>
                <div class="bg-green-50 p-3 rounded border border-green-200">
                  <div class="text-sm text-gray-800 whitespace-pre-wrap">
                    <%= format_placeholder_preview(msg.text, sample_appointment).gsub("\n", "<br>").html_safe %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
      
      <%# Contador e a√ß√£o %>
      <div class="flex flex-col justify-between">
        <div>
          <p class="text-sm font-medium text-gray-700 mb-2">Leads selecionados:</p>
          <div class="text-4xl font-bold text-blue-600 mb-4" data-bulk-message-target="counter">0</div>
        </div>
        
        <%= button_tag type: "button",
              class: "w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none",
              disabled: true,
              data: { 
                action: "click->bulk-message#sendBulkMessages",
                bulk_message_target: "sendButton"
              } do %>
          <i class="fas fa-paper-plane mr-2"></i>
          Enviar para Selecionados
        <% end %>
        
        <%# Bot√µes auxiliares %>
        <div class="mt-2 space-y-2">
          <%= button_tag type: "button",
                class: "w-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm py-2 px-4 rounded transition-all",
                data: { action: "click->bulk-message#selectAll" } do %>
            <i class="fas fa-check-double mr-1"></i> Selecionar Todos
          <% end %>
          
          <%= button_tag type: "button",
                class: "w-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm py-2 px-4 rounded transition-all",
                data: { action: "click->bulk-message#deselectAll" } do %>
            <i class="fas fa-times mr-1"></i> Desmarcar Todos
          <% end %>
        </div>
      </div>
    </div>
    
    <%# Bot√µes de Gerenciamento da Fila %>
    <div class="mt-4 flex flex-wrap justify-center gap-3">
      <button type="button"
              class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2"
              data-action="click->bulk-message#loadPreviousMessages"
              data-bulk-message-target="loadPreviousBtn">
        <i class="fas fa-history"></i>
        Carregar Pr√©-Agendadas
      </button>
      
      <button type="button"
              class="bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white font-semibold py-2.5 px-5 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2"
              data-action="click->bulk-message#clearAllScheduledMessages">
        <i class="fas fa-trash-alt"></i>
        Limpar Toda a Fila
      </button>
    </div>
    
    <%# √Årea de Logs de Envio em Tempo Real %>
    <%# Inscri√ß√£o no canal Turbo Stream para atualiza√ß√µes em tempo real do backend %>
    <%= turbo_stream_from "bulk_message_logs" %>
    
    <div class="mt-6 hidden" data-bulk-message-target="logsContainer">
      <div class="bg-gray-900 rounded-lg shadow-lg overflow-hidden">
        <%# Cabe√ßalho dos logs %>
        <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-4 py-3 border-b border-gray-700">
          <div class="flex items-center justify-between">
            <h4 class="text-white font-semibold flex items-center gap-2">
              <i class="fas fa-terminal text-green-400"></i>
              Logs de Envio em Tempo Real
            </h4>
            <div class="flex items-center gap-4 text-sm">
              <span class="text-gray-400" title="Jobs disparados (aguardando confirma√ß√£o do servidor)">
                <i class="fas fa-cog mr-1"></i>
                <span data-bulk-message-target="sentCount">0</span> processados
              </span>
              <span class="text-gray-400">
                <i class="fas fa-clock mr-1"></i>
                <span data-bulk-message-target="pendingCount">0</span> na fila
              </span>
              <span class="text-yellow-400" title="Leads sem WhatsApp (pulados automaticamente)">
                <i class="fab fa-whatsapp mr-1"></i>
                <span data-bulk-message-target="skippedCount">0</span> sem zap
              </span>
              <span class="text-gray-400">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                <span data-bulk-message-target="errorCount">0</span> erros
              </span>
            </div>
          </div>
        </div>
        
        <%# Barra de progresso %>
        <div class="bg-gray-800 px-4 py-2 border-b border-gray-700">
          <div class="flex items-center gap-3">
            <div class="flex-1 bg-gray-700 rounded-full h-3 overflow-hidden">
              <div class="bg-gradient-to-r from-blue-500 to-green-500 h-full transition-all duration-500"
                   data-bulk-message-target="progressBar"
                   style="width: 0%"></div>
            </div>
            <span class="text-white text-sm font-mono" data-bulk-message-target="progressText">0%</span>
          </div>
        </div>
        
        <%# Timer do pr√≥ximo envio - mais vis√≠vel %>
        <div class="bg-gradient-to-r from-yellow-900/50 to-orange-900/50 px-4 py-3 border-b border-yellow-600/30 hidden" data-bulk-message-target="timerContainer">
          <div class="flex items-center justify-center gap-4">
            <div class="flex items-center gap-2 text-yellow-400">
              <i class="fas fa-clock text-2xl animate-pulse"></i>
              <div class="text-left">
                <div class="text-xs text-yellow-300/70">Pr√≥xima mensagem para:</div>
                <div class="text-sm font-semibold timer-lead-name">--</div>
              </div>
            </div>
            <div class="bg-black/30 px-4 py-2 rounded-lg">
              <span class="font-mono text-3xl font-bold text-yellow-300" data-bulk-message-target="timer">--:--</span>
            </div>
          </div>
        </div>
        
        <%# Console de logs com altura autom√°tica %>
        <div id="bulk-logs-content"
             class="bg-black p-4 font-mono text-sm text-green-400 max-h-[600px] overflow-y-auto" 
             data-bulk-message-target="logsContent"
             style="min-height: 400px;">
          <div class="text-gray-500">
            <i class="fas fa-info-circle mr-2"></i>Aguardando in√≠cio do envio...
          </div>
        </div>
        
        <%# Rodap√© com a√ß√µes %>
        <div class="bg-gray-800 px-4 py-3 border-t border-gray-700 flex justify-between items-center">
          <div class="flex gap-3">
            <button type="button"
                    class="text-sm text-gray-400 hover:text-white transition-colors"
                    data-action="click->bulk-message#clearLogs">
              <i class="fas fa-trash mr-1"></i> Limpar Logs
            </button>
            <button type="button"
                    class="text-sm text-blue-400 hover:text-blue-300 transition-colors"
                    onclick="window.location.reload()">
              <i class="fas fa-sync-alt mr-1"></i> Recarregar P√°gina
            </button>
          </div>
          <button type="button"
                  class="text-sm text-gray-400 hover:text-white transition-colors"
                  data-action="click->bulk-message#toggleAutoScroll">
            <i class="fas fa-arrow-down mr-1"></i>
            <span data-bulk-message-target="autoScrollText">Auto-scroll: ON</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <% end %>
  
  <style>
    /* Anima√ß√£o para novos logs */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    [data-bulk-message-target="logsContent"] > div {
      animation: slideIn 0.3s ease-out;
    }
    
    /* Scrollbar customizada para os logs */
    [data-bulk-message-target="logsContent"]::-webkit-scrollbar {
      width: 8px;
    }
    
    [data-bulk-message-target="logsContent"]::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    
    [data-bulk-message-target="logsContent"]::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 4px;
    }
    
    [data-bulk-message-target="logsContent"]::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }
    
    /* Anima√ß√£o da barra de progresso */
    [data-bulk-message-target="progressBar"] {
      transition: width 0.5s ease-out;
    }
    
    /* Anima√ß√£o do modal de confirma√ß√£o */
    @keyframes scale-in {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .animate-scale-in {
      animation: scale-in 0.2s ease-out;
    }
  </style>
  
  <!-- Add result count display -->
  <div class="my-4 px-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div class="text-gray-700">
      <!-- Format the count -->
      <%= number_with_delimiter(@leads.total_count, delimiter: ".") %> 
      <!-- Determine singular or plural word based on count -->
      <%= @leads.total_count == 1 ? 'resultado' : 'resultados' %> 
      encontrado(s).
    </div>
    
    <%# Bot√£o para adicionar todos os leads da p√°gina √† fila de liga√ß√µes %>
    <% if current_account&.directcall_configured? && @rows.any? %>
      <% 
        # Preparar dados dos leads de forma eficiente
        leads_data = @leads.map do |lead| 
          # Usar o appointment j√° carregado pela query complexa
          appointment_id = lead.respond_to?(:current_appointment_id) ? lead.current_appointment_id : lead.appointments.last&.id
          
          # Buscar o appointment completo apenas se necess√°rio
          appointment = lead.appointments.find_by(id: appointment_id) if appointment_id
          
          next unless appointment
          
          {
            id: lead.id,
            appointment_id: appointment.id,
            name: lead.name,
            phone: lead.phone,
            service_date: appointment.service.date.strftime('%d/%m/%Y'),
            appointment_comments: appointment.comments || 'Sem observa√ß√µes',
            status: lead.no_interest ? 'Sem interesse' : 
                    (lead.respond_to?(:unified_last_contact_at) && lead.unified_last_contact_at.present? ? 'Contatado' : 'Ausente')
          }
        end.compact
      %>
      <button type="button"
              class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 flex items-center gap-3 text-base"
              data-action="click->call-queue#addAllToQueue"
              data-leads="<%= leads_data.to_json.gsub('"', '&quot;') %>"
              title="Adicionar todos os <%= leads_data.size %> leads desta p√°gina √† fila de liga√ß√µes">
        <i class="fas fa-plus-circle text-lg"></i>
        <span>Adicionar Todos √† Fila (<%= leads_data.size %>)</span>
      </button>
    <% end %>
  </div>
  
  <div id="table-tab" class="tab-content">
  </div>
  
  <br>
  <br>
  <%# Render table or cards view based on @view_type %>
  <% if @view_type == 'cards' %>
    <%= render partial: "absent_cards", locals: { rows: @rows, leads: @leads } %>
  <% else %>
    <%= render partial: "absent_table", locals: { rows: @rows, leads: @leads } %>
  <% end %>

<% end %>

</div><%# Fecha o wrapper do call-queue controller %>

<style>
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.pagination {
  display: flex;
  justify-content: center;
  padding: 1em 0;
}

.pagination li {
  list-style: none;
}

.pagination li a {
  margin: 0 0.5em;
  padding: 0.5em 1em;
  border: 1px solid #e2e8f0; /* border-gray-300 */
  color: #4a5568; /* text-gray-700 */
}

.pagination li.active a,
.pagination li a:hover {
  background-color: #edf2f7; /* bg-gray-200 */
  color: #2d3748; /* text-gray-800 */
}

.pagination li.disabled a {
  color: #a0aec0; /* text-gray-400 */
  cursor: not-allowed;
}

/* If you are using SVG for the icons: */
.pagination li a svg {
  vertical-align: middle;
}

@media (max-width: 768px) {

  .pagination {
    flex-direction: column;
  }

  .pagination li {
    margin: 10px;
  }

  #search_absent{
    width: 100%;
  }

  #search-results-container {
    width: 100%;
    margin: 10px;
  }
}

@media (min-width: 768px) {
  #search_absent{
    width: 500px;
  }
}

</style>

