<div id="<%= dom_id lead %>" class="bg-white shadow overflow-hidden sm:rounded-lg p-6 mb-4">
  <div class="px-4 py-5 sm:px-6">
    <h3 class="text-lg leading-6 text-gray-900 text-[18px]">
      Informações do responsável desta ficha
    </h3>
  </div>
  <div class="border-t border-gray-200">
    <dl>
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Nome
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <%= lead.name %>
        </dd>
      </div>
      <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Telefone
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <div id="phone-container-<%= lead.id %>" 
               data-controller="message-tracking"
               data-message-tracking-lead-id-value="<%= lead.id %>"
               data-message-tracking-appointment-id-value="<%= @old_appointment&.id %>">
            <div class="flex items-center">
              <% if lead.phone.present? %>
                <%= masked_whatsapp_link(lead.phone) %>
              <% else %>
                <span class="text-red-500 text-sm italic">
                  Telefone não cadastrado
                </span>
              <% end %>
            </div>
            
            <% if @old_appointment&.last_message_sent_at.present? %>
              <div class="text-xs text-gray-500 mt-1">
                Última mensagem: <%= time_ago_in_words(@old_appointment.last_message_sent_at) %> atrás 
                por <%= @old_appointment.last_message_sent_by %>
              </div>
            <% end %>
          </div>
        </dd>
      </div>
      
      <!-- Status Management Section -->
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 border-l-4 border-blue-500">
        <dt class="text-gray-500 text-[18px] font-semibold">
          Status do Lead
        </dt>
        <dd class="mt-1 sm:mt-0 sm:col-span-2">
          <% if lead.hidden_from_absent || lead.no_whatsapp || lead.no_interest %>
            <!-- Mostrar status atual e botão restaurar -->
            <div class="flex flex-wrap items-center gap-3 mb-3">
              <% if lead.hidden_from_absent %>
                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                  <i class="fas fa-eye-slash mr-1"></i> Contato futuro
                </span>
              <% end %>
              <% if lead.no_whatsapp %>
                <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-medium">
                  <i class="fab fa-whatsapp mr-1"></i> Sem WhatsApp
                </span>
              <% end %>
              <% if lead.no_interest %>
                <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium">
                  <i class="fas fa-times mr-1"></i> Sem Interesse
                </span>
              <% end %>
            </div>
            
            <%= button_to clinic_management.restore_lead_lead_path(lead), 
                method: :patch,
                data: { 
                  turbo_method: :patch,
                  confirm: "Tem certeza que deseja restaurar este lead na listagem principal?"
                },
                class: "bg-green-500 hover:bg-green-600 active:bg-green-700 text-white text-sm px-4 py-2 rounded-lg shadow-md flex items-center gap-2 transition-all duration-200 transform hover:scale-105",
                title: "Restaurar na lista principal" do %>
              <i class="fas fa-undo"></i> Restaurar Lead
            <% end %>
          <% else %>
            <!-- Botões para marcar status -->
            <div class="text-sm text-gray-600 mb-3">
              Lançar ficha para a lista de:
            </div>
              
              <%= button_to clinic_management.hide_from_absent_lead_path(lead), 
                  method: :patch,
                  data: { 
                    turbo_method: :patch,
                    confirm: "Tem certeza que deseja ocultar este lead da listagem?"
                  },
                  class: "bg-red-500 hover:bg-red-600 active:bg-red-700 text-white text-sm px-3 py-2 rounded-lg shadow-md flex items-center gap-2 transition-all duration-200 transform hover:scale-105",
                  title: "Ocultar da lista" do %>
                <i class="fas fa-calendar-plus"></i> Contato futuro
              <% end %>
              
              <%= button_to clinic_management.mark_no_interest_lead_path(lead), 
                  method: :patch,
                  data: { 
                    turbo_method: :patch,
                    confirm: "Marcar este lead como 'Sem interesse'?"
                  },
                  class: "bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white text-sm px-3 py-2 rounded-lg shadow-md flex items-center gap-2 transition-all duration-200 transform hover:scale-105",
                  title: "Sem interesse" do %>
                <i class="fas fa-times"></i> Sem Interesse
              <% end %>
            </div>
          <% end %>
        </dd>
      </div>
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Endereço
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <%= lead.address %>
        </dd>
      </div>
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Latitude
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <%= lead.latitude %>
        </dd>
      </div>
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Longitude
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <%= lead.longitude %>
        </dd>
      </div>
      <% if lead.latitude.present? && lead.longitude.present? %>
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Localização
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <a target='_blank' href='https://www.google.com/maps/search/?api=1&query=<%= lead.latitude %>,<%= lead.longitude %>' class="text-[18px]">Ver localização</a>
        </dd>
      </div>
      <% end %>
      <% unless referral?(current_user) %>
      <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Cliente convertido?
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <% if lead.leads_conversion.present? %>
            <%= link_to "Página do cliente", main_app.customer_orders_path(lead.customer), class: "text-blue-500 hover:text-blue-800 underline text-[18px]" %>
          <% else %>
            <%= link_to "Converter para cliente", main_app.new_conversion_path(lead_id: lead.id), class: "text-red-500 hover:text-red-800 underline text-[18px]" %>
          <% end %>
        </dd>
      </div>
      <% end %>
    </dl>
  </div>
</div>
<div class="my-8 mx-4">
  <h2 class="text-xl leading-6 text-gray-900 mb-4 text-[18px]">
    <b>Dados dos últimos atendimentos</b>
  </h2>
  <div class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
    <%= data_table(@rows) %>
  </div>
</div>