<div id="<%= dom_id lead %>" class="bg-white shadow overflow-hidden sm:rounded-lg p-6 mb-4">
  <div class="px-4 py-5 sm:px-6">
    <h3 class="text-lg leading-6 text-gray-900 text-[18px]">
      Informações do responsável desta ficha
    </h3>
  </div>
  <div class="border-t border-gray-200">
    <dl>
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Nome
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <%= lead.name %>
        </dd>
      </div>
      <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Telefone
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <%= render 'phone_with_message_tracking', lead: lead, appointment: @old_appointment %>
        </dd>
      </div>
      
      <!-- Status Management Section -->
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 border-l-4 border-blue-500">
        <dt class="text-gray-500 text-[18px] font-semibold">
          Status do Lead
        </dt>
        <dd class="mt-1 sm:mt-0 sm:col-span-2">
          <% if lead.hidden_from_absent || lead.no_interest || lead.wrong_phone %>
            <!-- Mostrar status atual e botão restaurar -->
            <div class="flex flex-wrap items-center gap-3 mb-3">
              <% if lead.hidden_from_absent %>
                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                  <i class="fas fa-eye-slash mr-1"></i> Contato futuro
                </span>
              <% end %>
              <% if lead.no_interest %>
                <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium">
                  <i class="fas fa-times mr-1"></i> Sem Interesse
                </span>
              <% end %>
              <% if lead.wrong_phone %>
                <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-medium">
                  <i class="fas fa-phone-slash mr-1"></i> Telefone errado
                </span>
              <% end %>
            </div>
            
            <%= button_to clinic_management.restore_lead_lead_path(lead), 
                method: :patch,
                data: { 
                  turbo_method: :patch,
                  confirm: "Tem certeza que deseja restaurar este lead na listagem principal?"
                },
                class: "w-full sm:w-auto bg-green-500 hover:bg-green-600 active:bg-green-700 text-white text-sm px-4 py-2 rounded-lg shadow-md flex items-center justify-center gap-2 transition-all duration-200 transform hover:scale-105",
                title: "Restaurar na lista principal" do %>
              <i class="fas fa-undo"></i> Restaurar Lead
            <% end %>
          <% else %>
            <!-- Botões para marcar status -->
            <div class="text-sm text-gray-600 mb-3">
              Lançar ficha para a lista de:
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
              <%= button_to clinic_management.hide_from_absent_lead_path(lead), 
                  method: :patch,
                  data: { 
                    turbo_method: :patch,
                    confirm: "Tem certeza que deseja ocultar este lead da listagem?"
                  },
                  class: "w-full sm:w-auto bg-red-500 hover:bg-red-600 active:bg-red-700 text-white text-sm px-3 py-2 rounded-lg shadow-md flex items-center justify-center gap-2 transition-all duration-200 transform hover:scale-105",
                  title: "Ocultar da lista" do %>
                <i class="fas fa-calendar-plus"></i> Contato futuro
              <% end %>
              
              <%= button_to clinic_management.mark_no_interest_lead_path(lead), 
                  method: :patch,
                  data: { 
                    turbo_method: :patch,
                    confirm: "Marcar este lead como 'Sem interesse'?"
                  },
                  class: "w-full sm:w-auto bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white text-sm px-3 py-2 rounded-lg shadow-md flex items-center justify-center gap-2 transition-all duration-200 transform hover:scale-105",
                  title: "Sem interesse" do %>
                <i class="fas fa-times"></i> Sem Interesse
              <% end %>
              
              <%= button_to clinic_management.mark_wrong_phone_lead_path(lead), 
                  method: :patch,
                  data: { 
                    turbo_method: :patch,
                    confirm: "Marcar este lead como 'Telefone errado'?"
                  },
                  class: "w-full sm:w-auto bg-orange-500 hover:bg-orange-600 active:bg-orange-700 text-white text-sm px-3 py-2 rounded-lg shadow-md flex items-center justify-center gap-2 transition-all duration-200 transform hover:scale-105",
                  title: "Telefone errado" do %>
                <i class="fas fa-phone-slash"></i> Telefone errado
              <% end %>
            </div>
          <% end %>
        </dd>
      </div>
      <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Endereço
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <%= lead.address %>
        </dd>
      </div>
      
      <%# ============================================================================
          Self-Booking Link Section
          
          Allows staff to generate and copy a unique self-booking link for the patient.
          The patient can use this link to self-schedule their appointment via WhatsApp.
          
          TWO SEPARATE TRACKING CONCEPTS:
          1. ref (referral attribution) - WHO GETS THE COMMISSION
             - If current user is a referral -> use their referral ID
             - If lead has attributed referral (within 180-day grace period) -> use that referral
             - Otherwise -> no ref param (will be attributed to "Local")
          
          2. reg_by (registered by) - WHO SHARED THE LINK (effort tracking)
             - Always includes current_user.id when a user is logged in
             - Tracks who did the work of sharing the link
             - Example: Assistant Jussara sends link -> reg_by=jussara_user_id
          
          ESSENTIAL: This feature requires the self_booking_token migration to be run.
          ============================================================================ %>
      <%
        # Build URL parameters for self-booking link
        url_params = {}
        
        # 1. REFERRAL ATTRIBUTION (who gets commission)
        if referral?(current_user) && user_referral.present?
          # Current user is a referral - they get credit
          url_params[:ref] = user_referral.id
        elsif lead.respond_to?(:current_attributed_referral) && lead.current_attributed_referral.present?
          # Lead has attributed referral within 180-day grace period
          url_params[:ref] = lead.current_attributed_referral.id
        end
        
        # 2. REGISTERED BY (who shared the link - effort tracking)
        # ESSENTIAL: Always include current_user.id so we know who shared the link
        url_params[:reg_by] = current_user.id if current_user.present?
        
        # Build the self-booking link with all parameters
        self_booking_link = clinic_management.self_booking_path(lead.self_booking_token!, url_params)
        full_link = "#{request.base_url}#{self_booking_link}"
        
        # Get attributed referral for display (if any)
        attributed_referral = lead.respond_to?(:current_attributed_referral) ? lead.current_attributed_referral : nil
      %>
      <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 border-l-4 border-emerald-500">
        <dt class="text-gray-500 text-[18px] font-semibold">
          <i class="fas fa-calendar-check text-emerald-500 mr-2"></i>
          Link de Auto-Marcação
        </dt>
        <dd class="mt-1 sm:mt-0 sm:col-span-2">
          <div class="text-sm text-gray-600 mb-3">
            Envie este link para o paciente agendar sua própria consulta:
          </div>
          
          <%# Show attribution info badges %>
          <div class="flex flex-wrap gap-2 mb-2">
            <%# Show referral attribution (who gets commission) %>
            <% if referral?(current_user) && user_referral.present? %>
              <div class="text-xs text-emerald-600 bg-emerald-50 px-3 py-1 rounded-lg inline-flex items-center">
                <i class="fas fa-user-tag mr-1"></i>
                Comissão: <strong class="ml-1"><%= user_referral.name %></strong>
              </div>
            <% elsif attributed_referral.present? %>
              <div class="text-xs text-emerald-600 bg-emerald-50 px-3 py-1 rounded-lg inline-flex items-center">
                <i class="fas fa-user-tag mr-1"></i>
                Comissão: <strong class="ml-1"><%= attributed_referral.name %></strong>
                <span class="ml-1 text-emerald-500">(180 dias)</span>
              </div>
            <% end %>
            
            <%# Show who is sharing the link (effort tracking) %>
            <% if current_user.present? %>
              <div class="text-xs text-blue-600 bg-blue-50 px-3 py-1 rounded-lg inline-flex items-center">
                <i class="fas fa-share-alt mr-1"></i>
                Compartilhado por: <strong class="ml-1"><%= current_user.name %></strong>
              </div>
            <% end %>
          </div>
          
          <div data-controller="copy-link" class="flex flex-col sm:flex-row gap-2">
            <input type="text" 
                   data-copy-link-target="input"
                   value="<%= full_link %>"
                   readonly
                   class="flex-1 px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg 
                          text-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-200"
                   onclick="this.select()">
            
            <button data-action="click->copy-link#copy"
                    class="w-full sm:w-auto bg-emerald-500 hover:bg-emerald-600 active:bg-emerald-700 
                           text-white text-sm px-4 py-2 rounded-lg shadow-md 
                           flex items-center justify-center gap-2 
                           transition-all duration-200 transform hover:scale-105
                           copy-link-btn">
              <i data-copy-link-target="icon" class="fas fa-copy"></i>
              <span data-copy-link-target="label">Copiar link</span>
            </button>
          </div>
          
          <div class="mt-3 flex flex-col sm:flex-row gap-2">
            <%# Direct WhatsApp share button with referral attribution %>
            <% whatsapp_message = "Olá! Segue o link para você agendar sua consulta: #{full_link}" %>
            <% if lead.phone.present? %>
              <a href="https://wa.me/55<%= lead.phone %>?text=<%= ERB::Util.url_encode(whatsapp_message) %>"
                 target="_blank"
                 class="w-full sm:w-auto bg-green-500 hover:bg-green-600 active:bg-green-700 
                        text-white text-sm px-4 py-2 rounded-lg shadow-md 
                        flex items-center justify-center gap-2 
                        transition-all duration-200 transform hover:scale-105">
                <i class="fab fa-whatsapp"></i>
                Enviar via WhatsApp
              </a>
            <% end %>
          </div>
          
          <p class="mt-2 text-xs text-gray-500">
            <i class="fas fa-info-circle mr-1"></i>
            O paciente poderá escolher dia e horário de forma simplificada.
          </p>
        </dd>
      </div>
      
      <% unless referral?(current_user) %>
      <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
        <dt class="text-gray-500 text-[18px]">
          Cliente convertido?
        </dt>
        <dd class="mt-1 text-gray-900 sm:mt-0 sm:col-span-2 text-[18px]">
          <% if lead.leads_conversion.present? %>
            <%= link_to "Página do cliente", main_app.customer_orders_path(lead.customer), class: "text-blue-500 hover:text-blue-800 underline text-[18px]" %>
          <% else %>
            <%= link_to "Converter para cliente", main_app.new_conversion_path(lead_id: lead.id), class: "text-red-500 hover:text-red-800 underline text-[18px]" %>
          <% end %>
        </dd>
      </div>
      <% end %>
    </dl>
  </div>
</div>
<div class="my-8 mx-4">
  <h2 class="text-xl leading-6 text-gray-900 mb-4 text-[18px]">
    <b>Dados dos últimos atendimentos</b>
  </h2>
  <div class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
    <%= data_table(@rows) %>
  </div>
</div>