<div data-controller="message-replicator" 
     data-message-replicator-lead-id-value="<%= lead.id %>"
     data-message-replicator-appointment-id-value="<%= appointment.present? ? appointment.id : '' %>">
  <div class="row">
    <div class="col s12">
      <%= form_with(url: build_message_path(lead), method: :post, remote: true, id: "whatsapp_form_#{lead.id}") do %>
        <div class="input-field">
          <%= select_tag :custom_message_id, 
            grouped_options_for_select(
              get_lead_messages(lead, appointment).map { |category, messages|
                [category, messages.map { |m| 
                  # Determine message type based on media attachment
                  type_label = if m.has_media?
                    case m.whatsapp_media_type
                    when 'image'
                      '[imagem]'
                    when 'audio'
                      '[áudio]'
                    when 'video'
                      '[vídeo]'
                    when 'document'
                      '[documento]'
                    else
                      '[mídia]'
                    end
                  else
                    ''
                  end
                  
                  ["#{m.name} #{type_label}", m.id] 
                }]
              }
            ),
            prompt: "Escolha uma mensagem", 
            class: "browser-default", 
            onchange: "this.form.requestSubmit()",
            data: { 
              message_replicator_target: "messageSelect",
              action: "change->message-replicator#updateReplicateButtonVisibility"
            }
          %>
          <%= hidden_field_tag :appointment_id, (appointment.present? ? appointment.id : "") %>
          <%= hidden_field_tag :context, (local_assigns[:context] || 'other') %>
        </div>
      <% end %>
      
      <%# Container para botões alinhados horizontalmente %>
      <div class="message-actions-container" style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
        <%# Botão para replicar mensagem aos demais %>
        <div data-message-replicator-target="replicateButtonContainer" style="display: none;">
          <button type="button" 
                  class="btn btn-small blue lighten-1 waves-effect waves-light"
                  data-action="click->message-replicator#replicateToAll"
                  data-message-replicator-target="replicateButton">
            <i class="material-icons left">content_copy</i>
            Replicar
          </button>
        </div>
        
        <%# Container para botões do WhatsApp %>
        <div id="whatsapp-link-<%=lead.id%>" class="whatsapp-buttons-container"></div>
      </div>
    </div>
  </div>
</div>

<style>
  #custom_message_id {
    width: 100%;
  }
  
  .mt-2 {
    margin-top: 8px;
  }
  
  .mt-1 {
    margin-top: 4px;
  }
</style>