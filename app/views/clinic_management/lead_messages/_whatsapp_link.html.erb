<%# Generate a unique suffix for element IDs to prevent collisions %>
<% unique_id_suffix = "#{lead_id}_#{appointment_id}" %>

<%# 
  Wrap the link in a div. This div will be the root for the Stimulus controller.
  The necessary data values (lead_id, appointment_id) are set on this controller div.
%>
<div id="whatsapp-message-container-<%= unique_id_suffix %>" 
     data-controller="message-tracking"
     data-message-tracking-lead-id-value="<%= lead_id %>"
     data-message-tracking-appointment-id-value="<%= appointment_id %>"
     data-message-tracking-message-id-value="<%= message_id %>"
     data-message-tracking-message-value="<%= message %>"
     data-message-tracking-raw-message-value="<%= CGI.unescape(message) %>"
     style="display: flex; flex-direction: column; gap: 8px;">

  <% if can_use_evolution_api? %>
    <%# Container principal com layout melhorado %>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <%# Botão principal - Enviar Automático %>
      <%= form_with url: send_evolution_message_lead_messages_path, method: :post, local: false, class: "w-full" do |form| %>
        <%= form.hidden_field :lead_id, value: lead_id %>
        <%= form.hidden_field :appointment_id, value: appointment_id %>
        <%= form.hidden_field :message_id, value: message_id %>
        <%= form.hidden_field :context, value: (local_assigns[:context] || 'other') %>
        <%= form.submit "Enviar pelo Sistema", 
              id: "evolution_send_button_#{unique_id_suffix}",
              class: "w-full bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-4 rounded cursor-pointer transition-all duration-200 shadow-sm",
              data: {
                action: "click->message-tracking#handleEvolutionButtonClick",
                message_tracking_target: "evolutionButton"
              } %>
      <% end %>
      
      <%# Container para opções secundárias %>
      <div style="display: flex; justify-content: center; align-items: center; gap: 16px; flex-wrap: wrap;">
        <%# Link manual %>
        <%= link_to whatsapp_link(phone_number, message), 
              id: "whatsapp_action_link_#{unique_id_suffix}", 
              target: "_blank", 
              class: "text-sm text-blue-600 hover:text-blue-700 underline font-medium inline-flex items-center gap-1",
              data: {
                action: "click->message-tracking#recordMessageSent"
              } do %>
          <i class="fab fa-whatsapp"></i>
          Enviar manualmente
        <% end %>
        
        <%# Separador visual %>
        <span class="text-gray-300">•</span>
        
        <%# Botão copiar %>
        <button type="button"
                class="text-sm text-gray-600 hover:text-gray-700 underline font-medium inline-flex items-center gap-1"
                data-action="click->message-tracking#copyMessageText"
                data-message-tracking-target="copyButton">
          <i class="far fa-copy"></i>
          Copiar mensagem
        </button>
      </div>
    </div>
    
    <%# Status message container - always visible but initially hidden %>
    <div data-message-tracking-target="statusMessage" class="hidden">
      <div class="flex items-center space-x-2">
        <div class="animate-spin rounded-full h-4 w-4 border-2 border-gray-300 border-t-green-600 hidden" data-message-tracking-target="loadingSpinner"></div>
        <span data-message-tracking-target="statusText" class="text-sm"></span>
      </div>
    </div>
  <% else %>
    <%# Manual WhatsApp link (quando não conectado) %>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <%= link_to "Enviar mensagem", 
            whatsapp_link(phone_number, message), 
            id: "whatsapp_action_link_#{unique_id_suffix}", 
            target: "_blank", 
            class: "nowrap bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded",
            data: {
              action: "click->message-tracking#recordMessageSent"
            } %>
      
      <%# Observações %>
      <div style="font-size: 12px; color: #666; text-align: center;">
        Observações
      </div>
      
      <%# Botão copiar mensagem %>
      <div style="display: flex; justify-content: center; align-items: center; gap: 16px;">
        <button type="button"
                class="text-sm text-gray-600 hover:text-gray-700 underline font-medium inline-flex items-center gap-1"
                data-action="click->message-tracking#copyMessageText"
                data-message-tracking-target="copyButton">
          <i class="far fa-copy"></i>
          Copiar mensagem
        </button>
      </div>
    </div>
  <% end %>
</div>

<%# = link_to "Enviar mensagem", "https://api.whatsapp.com/send/?phone=55#{phone_number}&text=#{message}", id: "whatsapp_link", target: "_blank", class: "nowrap bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded" %>
