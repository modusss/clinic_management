<%# Generate a unique suffix for element IDs to prevent collisions %>
<% unique_id_suffix = "#{lead_id}_#{appointment_id}" %>

<%# 
  Wrap the link in a div. This div will be the root for the Stimulus controller.
  The necessary data values (lead_id, appointment_id) are set on this controller div.
%>
<div id="whatsapp-message-container-<%= unique_id_suffix %>" 
     data-controller="message-tracking"
     data-message-tracking-lead-id-value="<%= lead_id %>"
     data-message-tracking-appointment-id-value="<%= appointment_id %>"
     style="display: flex; flex-direction: column; gap: 8px;">

  <% if can_use_evolution_api? %>
    <%# Container para botÃµes inline %>
    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
      <%# Evolution API automatic sending %>
      <%= form_with url: send_evolution_message_lead_messages_path, method: :post, local: false, class: "inline-block" do |form| %>
        <%= form.hidden_field :lead_id, value: lead_id %>
        <%= form.hidden_field :appointment_id, value: appointment_id %>
        <%= form.hidden_field :message_id, value: message_id %>
        <%= form.submit "Enviar Mensagem AutomÃ¡tica", 
              id: "evolution_send_button_#{unique_id_suffix}",
              class: "nowrap bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-4 rounded cursor-pointer transition-all duration-200",
              data: {
                action: "click->message-tracking#handleEvolutionButtonClick click->message-tracking#recordMessageSent",
                message_tracking_target: "evolutionButton"
              } %>
      <% end %>
      
      <%# Fallback manual option inline %>
      <%= link_to "Ou enviar manualmente", 
            whatsapp_link(phone_number, message), 
            id: "whatsapp_action_link_#{unique_id_suffix}", 
            target: "_blank", 
            class: "text-sm text-blue-600 hover:text-blue-800 underline",
            data: {
              action: "click->message-tracking#recordMessageSent"
            } %>
    </div>
    
    <%# Status message container - always visible but initially hidden %>
    <div data-message-tracking-target="statusMessage" class="hidden">
      <div class="flex items-center space-x-2">
        <div class="animate-spin rounded-full h-4 w-4 border-2 border-gray-300 border-t-green-600 hidden" data-message-tracking-target="loadingSpinner"></div>
        <span data-message-tracking-target="statusText" class="text-sm"></span>
      </div>
    </div>
  <% else %>
    <%# Manual WhatsApp link (original behavior) %>
    <%= link_to "Enviar mensagem", 
          whatsapp_link(phone_number, message), 
          id: "whatsapp_action_link_#{unique_id_suffix}", 
          target: "_blank", 
          class: "nowrap bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded",
          data: {
            action: "click->message-tracking#recordMessageSent"
          } %>
  <% end %>
</div>

<%# = link_to "Enviar mensagem", "https://api.whatsapp.com/send/?phone=55#{phone_number}&text=#{message}", id: "whatsapp_link", target: "_blank", class: "nowrap bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded" %>
