<% service_types = ClinicManagement::ServiceType.where(removed: false).order(:name) %>

<% service_types.each do |service_type| %>
  <% filtered_messages = messages_to_show.select { |m| m.service_type == service_type }.sort_by(&:created_at) %>
  
  <% if filtered_messages.any? %>
    <h6 class="text-xl font-bold mt-6 mb-4"><%= "#{service_type.name} (#{filtered_messages.count})" %></h6>
    <table class="w-full table-auto border-collapse border border-gray-300 text-left">
      <thead>
        <tr class="bg-gray-100">
          <% if show_type_column %>
            <th class="px-4 py-2">Tipo da Mensagem</th>
          <% end %>
          <th class="px-4 py-2">Nome da Mensagem</th>
          <th class="px-4 py-2">Texto da Mensagem</th>
          <th class="px-4 py-2">M√≠dia Anexada</th>
          <th class="px-4 py-2">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <% ClinicManagement::LeadMessage.message_types.keys.each do |message_type| %>
          <% type_filtered_messages = filtered_messages.select { |m| m.message_type == message_type } %>
          
          <% type_filtered_messages.each_with_index do |message, index| %>
            <tr class="border-b border-gray-200 hover:bg-gray-50">
              <% if show_type_column %>
                <td class="px-4 py-2"><%= "#{message.message_type.humanize} ##{index + 1}" %></td>
              <% end %>
              
              <td class="px-4 py-2"><%= message.name %></td>
              
              <td class="px-4 py-2"><%= message.text.gsub(/\n/, '<br>').html_safe %></td>
              
              <td class="px-4 py-2">
                <% if message.has_media? %>
                  <div class="media-preview">
                    <% case message.whatsapp_media_type %>
                    <% when 'image' %>
                      <div class="mb-2">
                        <%= image_tag message.media_url, 
                              alt: "Imagem anexada", 
                              class: "max-w-32 max-h-32 object-cover rounded border",
                              style: "cursor: pointer;",
                              onclick: "window.open('#{message.media_url}', '_blank')" %>
                      </div>
                      <p class="text-xs text-gray-600">üì∑ Imagem</p>
                    <% when 'audio' %>
                      <div class="mb-2">
                        <audio controls class="w-full max-w-48">
                          <source src="<%= message.media_url %>" type="<%= message.media_file.content_type %>">
                          Seu navegador n√£o suporta √°udio.
                        </audio>
                      </div>
                      <p class="text-xs text-gray-600">üéµ √Åudio</p>
                    <% when 'video' %>
                      <div class="mb-2">
                        <video controls class="max-w-32 max-h-32 rounded border">
                          <source src="<%= message.media_url %>" type="<%= message.media_file.content_type %>">
                            Seu navegador n√£o suporta v√≠deo.
                        </video>
                      </div>
                      <p class="text-xs text-gray-600">üé¨ V√≠deo</p>
                    <% when 'document' %>
                      <div class="mb-2">
                        <%= link_to message.media_url, target: "_blank", class: "text-blue-600 hover:text-blue-800" do %>
                          <div class="flex items-center space-x-2 p-2 border rounded bg-gray-50">
                            <span class="text-2xl">üìÑ</span>
                            <div>
                              <p class="text-sm font-medium">PDF</p>
                              <p class="text-xs text-gray-500">Clique para abrir</p>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                    <% if message.media_caption.present? %>
                      <p class="text-xs text-gray-700 italic mt-1">"<%= message.media_caption %>"</p>
                    <% end %>
                  </div>
                <% else %>
                  <span class="text-gray-400 text-sm">Sem m√≠dia</span>
                <% end %>
              </td>
              
              <td class="px-4 py-2 space-x-2" style="display: flex;">
                <% can_modify = is_manager_above? || message.message_type == 'outro' %>
                <% if can_modify %>
                  <%= link_to 'Editar', edit_lead_message_path(message), class: "px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600" %>
                  <%= button_to 'Excluir', message, method: :delete, data: { turbo_confirm: 'Tem certeza que deseja excluir esta mensagem?' }, class: "px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" %>
                <% else %>
                  <span class="text-gray-400 text-sm italic">Somente gerentes</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  <% end %>
<% end %>

<%# Section for messages not assigned to any ServiceType %>
<% unassigned_messages = messages_to_show.select { |m| m.service_type.nil? }.sort_by(&:created_at) %>
<% if unassigned_messages.any? %>
  <h6 class="text-xl font-bold mt-6 mb-4">Mensagens N√£o Atribu√≠das (<%= unassigned_messages.count %>)</h6>
  <table class="w-full table-auto border-collapse border border-gray-300 text-left">
    <thead>
      <tr class="bg-gray-100">
        <% if show_type_column %>
          <th class="px-4 py-2">Tipo da Mensagem</th>
        <% end %>
        <th class="px-4 py-2">Nome da Mensagem</th>
        <th class="px-4 py-2">Texto da Mensagem</th>
        <th class="px-4 py-2">M√≠dia Anexada</th>
        <th class="px-4 py-2">A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      <% ClinicManagement::LeadMessage.message_types.keys.each do |message_type| %>
        <% type_unassigned_messages = unassigned_messages.select { |m| m.message_type == message_type } %>
        
        <% type_unassigned_messages.each_with_index do |message, index| %>
          <tr class="border-b border-gray-200 hover:bg-gray-50">
            <% if show_type_column %>
              <td class="px-4 py-2"><%= "#{message.message_type.humanize} ##{index + 1}" %></td>
            <% end %>
            
            <td class="px-4 py-2"><%= message.name %></td>
            
            <td class="px-4 py-2"><%= message.text.gsub(/\n/, '<br>').html_safe %></td>
            
            <td class="px-4 py-2">
              <% if message.has_media? %>
                <div class="media-preview">
                  <% case message.whatsapp_media_type %>
                  <% when 'image' %>
                    <div class="mb-2">
                      <%= image_tag message.media_url, 
                            alt: "Imagem anexada", 
                            class: "max-w-32 max-h-32 object-cover rounded border",
                            style: "cursor: pointer;",
                            onclick: "window.open('#{message.media_url}', '_blank')" %>
                    </div>
                    <p class="text-xs text-gray-600">üì∑ Imagem</p>
                  <% when 'audio' %>
                    <div class="mb-2">
                      <audio controls class="w-full max-w-48">
                        <source src="<%= message.media_url %>" type="<%= message.media_file.content_type %>">
                        Seu navegador n√£o suporta √°udio.
                      </audio>
                    </div>
                    <p class="text-xs text-gray-600">üéµ √Åudio</p>
                  <% when 'video' %>
                    <div class="mb-2">
                      <video controls class="max-w-32 max-h-32 rounded border">
                        <source src="<%= message.media_url %>" type="<%= message.media_file.content_type %>">
                        Seu navegador n√£o suporta v√≠deo.
                      </video>
                    </div>
                    <p class="text-xs text-gray-600">üé¨ V√≠deo</p>
                  <% when 'document' %>
                    <div class="mb-2">
                      <%= link_to message.media_url, target: "_blank", class: "text-blue-600 hover:text-blue-800" do %>
                        <div class="flex items-center space-x-2 p-2 border rounded bg-gray-50">
                          <span class="text-2xl">üìÑ</span>
                          <div>
                            <p class="text-sm font-medium">PDF</p>
                            <p class="text-xs text-gray-500">Clique para abrir</p>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                  <% if message.media_caption.present? %>
                    <p class="text-xs text-gray-700 italic mt-1">"<%= message.media_caption %>"</p>
                  <% end %>
                </div>
              <% else %>
                <span class="text-gray-400 text-sm">Sem m√≠dia</span>
              <% end %>
            </td>
            
            <td class="px-4 py-2 space-x-2" style="display: flex;">
              <% can_modify = is_manager_above? || message.message_type == 'outro' %>
              <% if can_modify %>
                <%= link_to 'Editar', edit_lead_message_path(message), class: "px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600" %>
                <%= button_to 'Excluir', message, method: :delete, data: { turbo_confirm: 'Tem certeza que deseja excluir esta mensagem?' }, class: "px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" %>
              <% else %>
                <span class="text-gray-400 text-sm italic">Somente gerentes</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
<% end %>
