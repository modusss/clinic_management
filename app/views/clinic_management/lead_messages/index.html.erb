<%# ============================================================================
   # Lead Messages Index
   #
   # Three viewing modes:
   # 1. Referral user     → sees only their own messages (no dropdown, no tabs)
   # 2. Manager/owner     → sees global messages by default + dropdown to switch
   #                        to any referral's messages. Tabs only for global view.
   # 3. Other staff       → sees global messages with tabs (unchanged)
   # ============================================================================ %>

<div class="my-8">
  <% if @current_referral %>
    <h5 class="text-2xl font-bold">Minhas Mensagens Customizadas</h5>
    <p class="text-sm text-gray-600">Estas são as mensagens customizadas criadas por você.</p>
  <% else %>
    <h5 class="text-2xl font-bold">Mensagens Customizadas</h5>
  <% end %>
</div>

<%# ============================================================================
   # SECTION 1: Referral selector dropdown (managers only)
   # Shows only when there are referrals with messages.
   # Server-side filtering via query param — robust and simple.
   # ============================================================================ %>
<% if is_manager_above? && !@current_referral && @referrals_with_messages&.any? %>
  <div class="mb-6"
       data-controller="referral-messages"
       data-referral-messages-base-path-value="<%= lead_messages_path %>">
    <label for="referral-select" class="block text-sm font-medium text-gray-700 mb-2">
      Visualizar mensagens de:
    </label>
    <select id="referral-select"
            data-referral-messages-target="select"
            data-action="change->referral-messages#filterByReferral"
            class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-full max-w-md">
      <option value="" <%= 'selected' if @viewing_referral.nil? %>>
        Mensagens Globais (da conta)
      </option>
      <% @referrals_with_messages.each do |referral| %>
        <option value="<%= referral.id %>" <%= 'selected' if @viewing_referral&.id == referral.id %>>
          <%= referral.name %>
        </option>
      <% end %>
    </select>

    <% if @viewing_referral %>
      <p class="text-sm text-blue-600 mt-2">
        Visualizando mensagens de: <strong><%= @viewing_referral.name %></strong>
      </p>
    <% end %>
  </div>
<% end %>

<%# ============================================================================
   # SECTION 2: Content display
   # ============================================================================ %>

<% if @current_referral %>
  <%# REFERRALS: Show all their messages, no tabs, no dropdown (unchanged) %>
  <%= render partial: 'messages_table', locals: { messages_to_show: @messages, show_type_column: false } %>

<% elsif @viewing_referral.present? %>
  <%# MANAGER VIEWING A REFERRAL'S MESSAGES: No tabs needed (referrals only have "outro" type) %>
  <p class="text-sm text-gray-600 mb-4">
    Mensagens customizadas criadas por <strong><%= @viewing_referral.name %></strong>.
    Você pode editar e excluir estas mensagens.
  </p>
  <%= render partial: 'messages_table', locals: { messages_to_show: @messages, show_type_column: false } %>

<% else %>
  <%# GLOBAL VIEW: Tabs for Personalizadas / Globais (Stimulus-powered) %>
  <div data-controller="referral-messages">
    <div class="mb-6">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-4">
          <button data-referral-messages-target="tab"
                  data-tab="personalizadas"
                  data-action="click->referral-messages#switchTab"
                  class="py-2 px-4 border-b-2 font-medium text-sm transition-all border-blue-500 text-blue-600 cursor-pointer">
            Personalizadas
          </button>
          <button data-referral-messages-target="tab"
                  data-tab="globais"
                  data-action="click->referral-messages#switchTab"
                  class="py-2 px-4 border-b-2 font-medium text-sm transition-all border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer">
            Mensagens Globais
          </button>
        </nav>
      </div>
    </div>

    <%# TAB: Personalizadas %>
    <div data-referral-messages-target="tabContent" data-tab-name="personalizadas">
      <p class="text-sm text-gray-600 mb-4">Mensagens personalizadas que você criou. Você pode editar e excluir estas mensagens.</p>
      <% personalizadas = @messages.select { |m| m.message_type == 'outro' } %>
      <%= render partial: 'messages_table', locals: { messages_to_show: personalizadas, show_type_column: false } %>
    </div>

    <%# TAB: Mensagens Globais %>
    <div data-referral-messages-target="tabContent" data-tab-name="globais" style="display: none;">
      <p class="text-sm text-gray-600 mb-4">
        Mensagens de sistema (Confirmação, Remarcação, Lembrete, etc.).
        <%= is_manager_above? ? 'Você pode editá-las.' : 'Apenas gerentes podem editar estas mensagens.' %>
      </p>
      <% globais = @messages.select { |m| m.message_type != 'outro' } %>
      <%= render partial: 'messages_table', locals: { messages_to_show: globais, show_type_column: true } %>
    </div>
  </div>
<% end %>

<%# Button to create a new message %>
<div class="mt-8">
  <%= link_to 'Criar Nova Mensagem Customizada', new_lead_message_path, class: "px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" %>
</div>
