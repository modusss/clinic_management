<%# 
  Partial: Invitations & Reschedules Table
  Exibe convites e remarcações agrupados por data e referral
  Params: 
    - invitations_data: Hash com estrutura { date => { referral => { invitations: [], reschedules: [] } } }
%>

<div class="invitations-reschedules-container">
  <% if invitations_data.blank? %>
    <div class="empty-state">
      <div class="empty-state-icon">
        <i class="material-icons">event_busy</i>
      </div>
      <p class="empty-state-text">Nenhum convite ou remarcação encontrada</p>
    </div>
  <% else %>
    <% invitations_data.each do |date, referrals_data| %>
      <div class="date-section">
        <!-- Date Header -->
        <div class="date-header">
          <div class="date-header-content">
            <i class="material-icons">calendar_today</i>
            <span class="date-text"><%= show_week_day(date.strftime("%A")) %>, <%= date.strftime("%d/%m/%Y") %></span>
          </div>
        </div>

        <!-- Totals Summary (only show when multiple referrals) -->
        <% 
          total_invitations = referrals_data.sum { |_, data| data[:invitations].size }
          total_reschedules = referrals_data.sum { |_, data| data[:reschedules].size }
          total_general = total_invitations + total_reschedules
          show_totals = referrals_data.size > 1 && (total_invitations > 0 || total_reschedules > 0)
        %>
        
        <% if show_totals %>
          <div class="totals-summary">
            <div class="totals-content">
              <div class="total-item total-invitations">
                <i class="material-icons">event_available</i>
                <div class="total-info">
                  <span class="total-label">Total de Convites</span>
                  <span class="total-value"><%= total_invitations %></span>
                </div>
              </div>
              
              <div class="total-separator"></div>
              
              <div class="total-item total-reschedules">
                <i class="material-icons">update</i>
                <div class="total-info">
                  <span class="total-label">Total de Remarcações</span>
                  <span class="total-value"><%= total_reschedules %></span>
                </div>
              </div>

              <div class="total-separator"></div>

              <div class="total-item total-general">
                <i class="material-icons">functions</i>
                <div class="total-info">
                  <span class="total-label">Total Geral</span>
                  <span class="total-value"><%= total_general %></span>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Referrals Data Table (Desktop) -->
        <div class="referrals-table-wrapper desktop-only">
          <table class="referrals-table">
            <thead>
              <tr>
                <th class="col-referral">Indicador</th>
                <th class="col-count">Total</th>
                <th class="col-count" style="width: 100px; min-width: 100px">Interações</th>
                <th class="col-count">Qtd Convites</th>
                <th class="col-names">Convites</th>
                <th class="col-count">Qtd Remarcações</th>
                <th class="col-names">Remarcações</th>
              </tr>
            </thead>
            <tbody>
              <% if referrals_data.blank? || referrals_data.all? { |_, data| data[:invitations].blank? && data[:reschedules].blank? && data[:whatsapp_count] == 0 && data[:phone_count] == 0 } %>
                <tr class="empty-row">
                  <td colspan="7">
                    <span class="empty-message">Sem lançamentos</span>
                  </td>
                </tr>
              <% else %>
                <% referrals_data.sort_by { |_, data| -(data[:invitations].size + data[:reschedules].size) }.each do |referral, data| %>
                  <tr class="data-row">
                    <!-- Referral Name -->
                    <td class="referral-cell">
                      <div class="referral-name">
                        <i class="material-icons referral-icon">person</i>
                        <%= referral&.name || "Sem indicador" %>
                      </div>
                    </td>

                    <!-- Total Row Count -->
                    <td class="count-cell">
                      <span class="count-badge total-badge">
                        <%= data[:invitations].size + data[:reschedules].size %>
                      </span>
                    </td>

                    <!-- Interactions Count (WhatsApp / Phone) -->
                    <td class="count-cell">
                      <div class="interactions-cell">
                         <div class="interaction-item whatsapp" title="WhatsApp">
                           <i class="material-icons">chat</i>
                           <span><%= data[:whatsapp_count] %></span>
                         </div>
                         <div class="interaction-item phone" title="Ligação">
                           <i class="material-icons">phone</i>
                           <span><%= data[:phone_count] %></span>
                         </div>
                      </div>
                    </td>

                    <!-- Invitations Count -->
                    <td class="count-cell">
                      <span class="count-badge invitations-badge">
                        <%= data[:invitations].size %>
                      </span>
                    </td>

                    <!-- Invitations Names -->
                    <td class="names-cell">
                      <%# For referral users: only show names of their own patients, hide others' patient names %>
                      <% show_patient_names = !@is_referral_user || (referral && @current_user_referral && referral.id == @current_user_referral.id) %>
                      <% if data[:invitations].any? %>
                        <% if show_patient_names %>
                          <div class="patient-links">
                            <% data[:invitations].each_with_index do |invitation, index| %>
                              <%= render partial: "patient_name_display", 
                                         locals: {
                                           invitation: invitation,
                                           count: invitation.lead.appointments.count,
                                           self_booked: invitation.appointments.any?(&:self_booked?)
                                         } %>
                              <%= ", " unless index == data[:invitations].size - 1 %>
                            <% end %>
                          </div>
                        <% else %>
                          <span class="empty-cell hidden-names" title="Nomes ocultos para privacidade"><%= data[:invitations].size %> paciente(s)</span>
                        <% end %>
                      <% else %>
                        <span class="empty-cell">—</span>
                      <% end %>
                    </td>

                    <!-- Reschedules Count -->
                    <td class="count-cell">
                      <span class="count-badge reschedules-badge">
                        <%= data[:reschedules].size %>
                      </span>
                    </td>

                    <!-- Reschedules Names -->
                    <td class="names-cell">
                      <%# For referral users: only show names of their own patients, hide others' patient names %>
                      <% show_reschedule_names = !@is_referral_user || (referral && @current_user_referral && referral.id == @current_user_referral.id) %>
                      <% if data[:reschedules].any? %>
                        <% if show_reschedule_names %>
                          <div class="patient-links">
                            <% data[:reschedules].each_with_index do |appointment, index| %>
                              <% invitation = appointment.invitation %>
                              <%= render partial: "patient_name_display", 
                                         locals: {
                                           invitation: invitation,
                                           count: appointment.lead.appointments.count,
                                           self_booked: appointment.self_booked?
                                         } %>
                              <%= ", " unless index == data[:reschedules].size - 1 %>
                            <% end %>
                          </div>
                        <% else %>
                          <span class="empty-cell hidden-names" title="Nomes ocultos para privacidade"><%= data[:reschedules].size %> paciente(s)</span>
                        <% end %>
                      <% else %>
                        <span class="empty-cell">—</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Referrals Cards (Mobile) -->
        <div class="referrals-cards-wrapper mobile-only">
          <% if referrals_data.blank? || referrals_data.all? { |_, data| data[:invitations].blank? && data[:reschedules].blank? && data[:whatsapp_count] == 0 && data[:phone_count] == 0 } %>
            <div class="empty-card">
              <span class="empty-message">Sem lançamentos</span>
            </div>
          <% else %>
            <% referrals_data.sort_by { |_, data| -(data[:invitations].size + data[:reschedules].size) }.each do |referral, data| %>
              <div class="referral-card">
                <!-- Card Header: Referral Name + Total -->
                <div class="card-header">
                  <div class="card-referral-name">
                    <i class="material-icons">person</i>
                    <span><%= referral&.name || "Sem indicador" %></span>
                  </div>
                  <span class="count-badge total-badge">
                    <%= data[:invitations].size + data[:reschedules].size %>
                  </span>
                </div>

                <!-- Card Stats Row -->
                <div class="card-stats-row">
                  <div class="card-stat">
                    <div class="interaction-item whatsapp" title="WhatsApp">
                      <i class="material-icons">chat</i>
                      <span><%= data[:whatsapp_count] %></span>
                    </div>
                  </div>
                  <div class="card-stat">
                    <div class="interaction-item phone" title="Ligação">
                      <i class="material-icons">phone</i>
                      <span><%= data[:phone_count] %></span>
                    </div>
                  </div>
                  <div class="card-stat">
                    <span class="stat-label">Convites</span>
                    <span class="count-badge invitations-badge"><%= data[:invitations].size %></span>
                  </div>
                  <div class="card-stat">
                    <span class="stat-label">Remarc.</span>
                    <span class="count-badge reschedules-badge"><%= data[:reschedules].size %></span>
                  </div>
                </div>

                <!-- Card Details (Expandable) -->
                <% show_patient_names = !@is_referral_user || (referral && @current_user_referral && referral.id == @current_user_referral.id) %>
                <% if data[:invitations].any? || data[:reschedules].any? %>
                  <div class="card-details">
                    <% if data[:invitations].any? %>
                      <div class="card-detail-section">
                        <span class="detail-label">Convites:</span>
                        <% if show_patient_names %>
                          <div class="patient-links">
                            <% data[:invitations].each_with_index do |invitation, index| %>
                              <%= render partial: "patient_name_display", 
                                         locals: {
                                           invitation: invitation,
                                           count: invitation.lead.appointments.count,
                                           self_booked: invitation.appointments.any?(&:self_booked?)
                                         } %>
                              <%= ", " unless index == data[:invitations].size - 1 %>
                            <% end %>
                          </div>
                        <% else %>
                          <span class="empty-cell hidden-names" title="Nomes ocultos para privacidade"><%= data[:invitations].size %> paciente(s)</span>
                        <% end %>
                      </div>
                    <% end %>
                    <% if data[:reschedules].any? %>
                      <div class="card-detail-section">
                        <span class="detail-label">Remarcações:</span>
                        <% show_reschedule_names = !@is_referral_user || (referral && @current_user_referral && referral.id == @current_user_referral.id) %>
                        <% if show_reschedule_names %>
                          <div class="patient-links">
                            <% data[:reschedules].each_with_index do |appointment, index| %>
                              <% invitation = appointment.invitation %>
                              <%= render partial: "patient_name_display", 
                                         locals: {
                                           invitation: invitation,
                                           count: appointment.lead.appointments.count,
                                           self_booked: appointment.self_booked?
                                         } %>
                              <%= ", " unless index == data[:reschedules].size - 1 %>
                            <% end %>
                          </div>
                        <% else %>
                          <span class="empty-cell hidden-names" title="Nomes ocultos para privacidade"><%= data[:reschedules].size %> paciente(s)</span>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<style>
/* ========================================
   INVITATIONS & RESCHEDULES TABLE STYLES
   Premium, Modern, Enterprise-Grade Design
   ======================================== */

.invitations-reschedules-container {
  width: 100%;
  margin: 0 auto;
  padding: 0;
}

/* Empty State */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.empty-state-icon {
  font-size: 4rem;
  color: #adb5bd;
  margin-bottom: 1rem;
}

.empty-state-icon i {
  font-size: 4rem;
}

.empty-state-text {
  font-size: 1.125rem;
  color: #6c757d;
  margin: 0;
}

/* Date Section */
.date-section {
  margin-bottom: 2.5rem;
  animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Date Header */
.date-header {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 8px 8px 0 0;
  padding: 0.875rem 1.5rem;
  margin-bottom: 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.date-header-content {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.date-header-content i {
  color: #60a5fa;
  font-size: 1.25rem;
}

.date-text {
  font-size: 1rem;
  font-weight: 600;
  color: #ffffff;
  letter-spacing: 0.025em;
  text-transform: uppercase;
}

/* Totals Summary */
.totals-summary {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-left: 4px solid #0ea5e9;
  padding: 1rem 1.5rem;
  margin-bottom: 0;
  border-bottom: 1px solid #cbd5e1;
}

.totals-content {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2rem;
}

.total-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.total-item i {
  font-size: 1.75rem;
}

.total-item.total-invitations i {
  color: #2563eb;
}

.total-item.total-reschedules i {
  color: #db2777;
}

.total-item.total-general i {
  color: #7c3aed; /* Violet for General Total */
}

.total-info {
  display: flex;
  flex-direction: column;
  gap: 0.125rem;
}

.total-label {
  font-size: 0.8125rem;
  font-weight: 500;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.total-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1e293b;
  line-height: 1;
}

.total-separator {
  width: 2px;
  height: 3rem;
  background: linear-gradient(180deg, transparent 0%, #cbd5e1 20%, #cbd5e1 80%, transparent 100%);
}

/* Table Wrapper */
.referrals-table-wrapper {
  background: #ffffff;
  border-radius: 0 0 8px 8px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* Table */
.referrals-table {
  width: 100%;
  border-collapse: collapse;
  background: #ffffff;
}

/* Table Header */
.referrals-table thead {
  background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
  border-bottom: 2px solid #e2e8f0;
}

.referrals-table thead th {
  padding: 1rem 1.25rem;
  text-align: left;
  font-size: 0.8125rem;
  font-weight: 600;
  color: #475569;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 2px solid #cbd5e1;
}

.referrals-table thead th.col-referral {
  width: 15%;
  min-width: 120px;
}

.referrals-table thead th.col-count {
  width: 10%;
  text-align: center;
  min-width: 80px;
}

.referrals-table thead th.col-names {
  width: 32.5%;
  min-width: 200px;
}

/* Table Body */
.referrals-table tbody tr {
  border-bottom: 1px solid #e2e8f0;
  transition: all 0.2s ease;
}

.referrals-table tbody tr:hover {
  background: #f8fafc;
}

.referrals-table tbody tr:last-child {
  border-bottom: none;
}

.referrals-table tbody td {
  padding: 1.125rem 1.25rem;
  vertical-align: middle;
  font-size: 0.9375rem;
  color: #1e293b;
}

/* Referral Cell */
.referral-cell {
  font-weight: 600;
}

.referral-name {
  display: flex;
  align-items: center;
  gap: 0.625rem;
}

.referral-icon {
  font-size: 1.25rem;
  color: #64748b;
}

/* Count Cell */
.count-cell {
  text-align: center;
}

.count-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 2.25rem;
  height: 2.25rem;
  padding: 0 0.75rem;
  border-radius: 6px;
  font-size: 0.9375rem;
  font-weight: 600;
  letter-spacing: 0.025em;
}

.invitations-badge {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  color: #1e40af;
  border: 1px solid #93c5fd;
}

.reschedules-badge {
  background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
  color: #be185d;
  border: 1px solid #f9a8d4;
}

.total-badge {
  background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
  color: #7e22ce;
  border: 1px solid #d8b4fe;
}

/* Interactions Cell */
.interactions-cell {
  display: flex;
  flex-direction: row;
  gap: 8px;
  align-items: center;
  justify-content: center;
}

.interaction-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.8rem;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 6px;
}

.interaction-item i {
  font-size: 16px;
}

.interaction-item.whatsapp {
  background-color: #dcfce7;
  color: #166534;
  border: 1px solid #bbf7d0;
}

.interaction-item.phone {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

/* Names Cell */
.names-cell {
  line-height: 1.6;
}

.patient-links {
  display: inline;
}

.patient-links a {
  color: #2563eb;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.15s ease;
}

.patient-links a:hover {
  color: #1d4ed8;
  text-decoration: underline;
}

.patient-name-with-origin {
  display: inline-flex;
  align-items: center;
  gap: 0.2rem;
}

.self-booking-indicator {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1rem;
  height: 1rem;
  border-radius: 999px;
  background: #ecfeff;
  border: 1px solid #a5f3fc;
  color: #0e7490;
  vertical-align: middle;
}

.self-booking-indicator i {
  font-size: 0.72rem;
  line-height: 1;
}

.empty-cell {
  color: #94a3b8;
  font-style: italic;
  font-size: 0.875rem;
}

/* Hidden names indicator for referral privacy */
.hidden-names {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  color: #64748b;
  font-style: normal;
  font-size: 0.8125rem;
  background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  border: 1px solid #cbd5e1;
}

/* Empty Row */
.empty-row td {
  text-align: center;
  padding: 2rem;
}

.empty-message {
  color: #64748b;
  font-size: 0.9375rem;
  font-style: italic;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .referrals-table thead th {
    padding: 0.875rem 1rem;
    font-size: 0.75rem;
  }

  .referrals-table tbody td {
    padding: 1rem;
    font-size: 0.875rem;
  }

  .count-badge {
    min-width: 2rem;
    height: 2rem;
    font-size: 0.875rem;
  }
}

/* ========================================
   RESPONSIVE VISIBILITY CLASSES
   ======================================== */

/* Desktop (>768px): show table, hide cards */
.desktop-only {
  display: block !important;
}

.mobile-only {
  display: none !important;
}

/* Mobile (<=768px): hide table, show cards - defined in @media query below */

/* ========================================
   MOBILE CARDS STYLES
   Note: These styles only apply when mobile-only is visible (on mobile)
   ======================================== */

.referrals-cards-wrapper {
  flex-direction: column;
  gap: 0.75rem;
  padding: 0.75rem;
  background: #ffffff;
  border-radius: 0 0 8px 8px;
}

.empty-card {
  text-align: center;
  padding: 2rem;
  color: #64748b;
  font-style: italic;
}

.referral-card {
  background: #ffffff;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 0;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
  overflow: hidden;
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.875rem 1rem;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-bottom: 1px solid #e2e8f0;
}

.card-referral-name {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  color: #1e293b;
  font-size: 0.9375rem;
}

.card-referral-name i {
  color: #64748b;
  font-size: 1.25rem;
}

.card-stats-row {
  display: flex;
  align-items: center;
  justify-content: space-around;
  padding: 0.75rem 0.5rem;
  background: #ffffff;
  border-bottom: 1px solid #f1f5f9;
}

.card-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
}

.stat-label {
  font-size: 0.6875rem;
  font-weight: 500;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.card-details {
  padding: 0.75rem 1rem;
  background: #fafbfc;
}

.card-detail-section {
  margin-bottom: 0.625rem;
}

.card-detail-section:last-child {
  margin-bottom: 0;
}

.detail-label {
  display: block;
  font-size: 0.75rem;
  font-weight: 600;
  color: #475569;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  margin-bottom: 0.375rem;
}

.card-details .patient-links {
  font-size: 0.8125rem;
  line-height: 1.5;
}

/* ========================================
   MOBILE RESPONSIVE OVERRIDES
   ======================================== */

@media (max-width: 768px) {
  /* Switch visibility: hide table, show cards */
  .desktop-only {
    display: none !important;
  }

  .mobile-only {
    display: flex !important;
    flex-direction: column;
  }

  .date-header {
    padding: 0.75rem 1rem;
    border-radius: 8px 8px 0 0;
  }

  .date-text {
    font-size: 0.8125rem;
  }

  .totals-summary {
    padding: 0.75rem 1rem;
  }

  .totals-content {
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: space-around;
  }

  .total-item {
    flex: 0 0 auto;
  }

  .total-item i {
    font-size: 1.25rem;
  }

  .total-label {
    font-size: 0.625rem;
  }

  .total-value {
    font-size: 1.125rem;
  }

  .total-separator {
    display: none;
  }

  .count-badge {
    min-width: 1.5rem;
    height: 1.5rem;
    font-size: 0.75rem;
    padding: 0 0.5rem;
  }

  .interaction-item {
    padding: 3px 6px;
    font-size: 0.75rem;
  }

  .interaction-item i {
    font-size: 14px;
  }
}

/* Extra small screens */
@media (max-width: 480px) {
  .date-header {
    padding: 0.625rem 0.75rem;
  }

  .date-text {
    font-size: 0.75rem;
  }

  .totals-content {
    gap: 0.5rem;
  }

  .total-item i {
    font-size: 1rem;
  }

  .total-label {
    font-size: 0.5625rem;
  }

  .total-value {
    font-size: 1rem;
  }

  .card-header {
    padding: 0.75rem;
  }

  .card-referral-name {
    font-size: 0.875rem;
  }

  .card-referral-name i {
    font-size: 1.125rem;
  }

  .card-stats-row {
    padding: 0.625rem 0.25rem;
  }

  .stat-label {
    font-size: 0.625rem;
  }

  .card-details {
    padding: 0.625rem 0.75rem;
  }

  .detail-label {
    font-size: 0.6875rem;
  }

  .card-details .patient-links {
    font-size: 0.75rem;
  }
}
</style>

